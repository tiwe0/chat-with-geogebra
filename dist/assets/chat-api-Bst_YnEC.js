import{w as xt,l as Tt,U as E,p as Y,c as te,g as ee,I as we,i as Be,T as Er,z as t,a as ye,b as Oe,d as fe,e as le,f as _n,h as kt,N as bn,r as Or,s as Me,j as xe,A as P,k as F,m as qr,n as Dr,o as $r,q as Ur,t as wn,u as Xe,v as St,x as xn,y as Lr,B as Hr}from"./index-FVsx2jyB.js";function Fr({prompt:e,useLegacyFunctionCalling:n=!1,systemMessageMode:r="system"}){const s=[],a=[];for(const{role:o,content:i}of e)switch(o){case"system":{switch(r){case"system":{s.push({role:"system",content:i});break}case"developer":{s.push({role:"developer",content:i});break}case"remove":{a.push({type:"other",message:"system messages are removed for this model"});break}default:{const l=r;throw new Error(`Unsupported system message mode: ${l}`)}}break}case"user":{if(i.length===1&&i[0].type==="text"){s.push({role:"user",content:i[0].text});break}s.push({role:"user",content:i.map((l,c)=>{var u,m,g,v;switch(l.type){case"text":return{type:"text",text:l.text};case"image":return{type:"image_url",image_url:{url:l.image instanceof URL?l.image.toString():`data:${(u=l.mimeType)!=null?u:"image/jpeg"};base64,${fe(l.image)}`,detail:(g=(m=l.providerMetadata)==null?void 0:m.openai)==null?void 0:g.imageDetail}};case"file":{if(l.data instanceof URL)throw new E({functionality:"'File content parts with URL data' functionality not supported."});switch(l.mimeType){case"audio/wav":return{type:"input_audio",input_audio:{data:l.data,format:"wav"}};case"audio/mp3":case"audio/mpeg":return{type:"input_audio",input_audio:{data:l.data,format:"mp3"}};case"application/pdf":return{type:"file",file:{filename:(v=l.filename)!=null?v:`part-${c}.pdf`,file_data:`data:application/pdf;base64,${l.data}`}};default:throw new E({functionality:`File content part type ${l.mimeType} in user messages`})}}}})});break}case"assistant":{let l="";const c=[];for(const u of i)switch(u.type){case"text":{l+=u.text;break}case"tool-call":{c.push({id:u.toolCallId,type:"function",function:{name:u.toolName,arguments:JSON.stringify(u.args)}});break}}if(n){if(c.length>1)throw new E({functionality:"useLegacyFunctionCalling with multiple tool calls in one message"});s.push({role:"assistant",content:l,function_call:c.length>0?c[0].function:void 0})}else s.push({role:"assistant",content:l,tool_calls:c.length>0?c:void 0});break}case"tool":{for(const l of i)n?s.push({role:"function",name:l.toolName,content:JSON.stringify(l.result)}):s.push({role:"tool",tool_call_id:l.toolCallId,content:JSON.stringify(l.result)});break}default:{const l=o;throw new Error(`Unsupported role: ${l}`)}}return{messages:s,warnings:a}}function Zt(e){var n,r;return(r=(n=e?.content)==null?void 0:n.map(({token:s,logprob:a,top_logprobs:o})=>({token:s,logprob:a,topLogprobs:o?o.map(({token:i,logprob:l})=>({token:i,logprob:l})):[]})))!=null?r:void 0}function Je(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var Ct=t.object({error:t.object({message:t.string(),type:t.string().nullish(),param:t.any().nullish(),code:t.union([t.string(),t.number()]).nullish()})}),ue=kt({errorSchema:Ct,errorToMessage:e=>e.error.message});function We({id:e,model:n,created:r}){return{id:e??void 0,modelId:n??void 0,timestamp:r!=null?new Date(r*1e3):void 0}}function Br({mode:e,useLegacyFunctionCalling:n=!1,structuredOutputs:r}){var s;const a=(s=e.tools)!=null&&s.length?e.tools:void 0,o=[];if(a==null)return{tools:void 0,tool_choice:void 0,toolWarnings:o};const i=e.toolChoice;if(n){const u=[];for(const g of a)g.type==="provider-defined"?o.push({type:"unsupported-tool",tool:g}):u.push({name:g.name,description:g.description,parameters:g.parameters});if(i==null)return{functions:u,function_call:void 0,toolWarnings:o};switch(i.type){case"auto":case"none":case void 0:return{functions:u,function_call:void 0,toolWarnings:o};case"required":throw new E({functionality:"useLegacyFunctionCalling and toolChoice: required"});default:return{functions:u,function_call:{name:i.toolName},toolWarnings:o}}}const l=[];for(const u of a)u.type==="provider-defined"?o.push({type:"unsupported-tool",tool:u}):l.push({type:"function",function:{name:u.name,description:u.description,parameters:u.parameters,strict:r?!0:void 0}});if(i==null)return{tools:l,tool_choice:void 0,toolWarnings:o};const c=i.type;switch(c){case"auto":case"none":case"required":return{tools:l,tool_choice:c,toolWarnings:o};case"tool":return{tools:l,tool_choice:{type:"function",function:{name:i.toolName}},toolWarnings:o};default:{const u=c;throw new E({functionality:`Unsupported tool choice type: ${u}`})}}}var Jr=class{constructor(e,n,r){this.specificationVersion="v1",this.modelId=e,this.settings=n,this.config=r}get supportsStructuredOutputs(){var e;return(e=this.settings.structuredOutputs)!=null?e:ft(this.modelId)}get defaultObjectGenerationMode(){return Gr(this.modelId)?"tool":this.supportsStructuredOutputs?"json":"tool"}get provider(){return this.config.provider}get supportsImageUrls(){return!this.settings.downloadImages}getArgs({mode:e,prompt:n,maxTokens:r,temperature:s,topP:a,topK:o,frequencyPenalty:i,presencePenalty:l,stopSequences:c,responseFormat:u,seed:m,providerMetadata:g}){var v,b,y,d,p,h,x,S;const f=e.type,_=[];o!=null&&_.push({type:"unsupported-setting",setting:"topK"}),u?.type==="json"&&u.schema!=null&&!this.supportsStructuredOutputs&&_.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});const k=this.settings.useLegacyFunctionCalling;if(k&&this.settings.parallelToolCalls===!0)throw new E({functionality:"useLegacyFunctionCalling with parallelToolCalls"});if(k&&this.supportsStructuredOutputs)throw new E({functionality:"structuredOutputs with useLegacyFunctionCalling"});const{messages:I,warnings:T}=Fr({prompt:n,useLegacyFunctionCalling:k,systemMessageMode:Kr(this.modelId)});_.push(...T);const C={model:this.modelId,logit_bias:this.settings.logitBias,logprobs:this.settings.logprobs===!0||typeof this.settings.logprobs=="number"?!0:void 0,top_logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:r,temperature:s,top_p:a,frequency_penalty:i,presence_penalty:l,response_format:u?.type==="json"?this.supportsStructuredOutputs&&u.schema!=null?{type:"json_schema",json_schema:{schema:u.schema,strict:!0,name:(v=u.name)!=null?v:"response",description:u.description}}:{type:"json_object"}:void 0,stop:c,seed:m,max_completion_tokens:(b=g?.openai)==null?void 0:b.maxCompletionTokens,store:(y=g?.openai)==null?void 0:y.store,metadata:(d=g?.openai)==null?void 0:d.metadata,prediction:(p=g?.openai)==null?void 0:p.prediction,reasoning_effort:(x=(h=g?.openai)==null?void 0:h.reasoningEffort)!=null?x:this.settings.reasoningEffort,messages:I};switch(ft(this.modelId)&&(C.temperature!=null&&(C.temperature=void 0,_.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),C.top_p!=null&&(C.top_p=void 0,_.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"})),C.frequency_penalty!=null&&(C.frequency_penalty=void 0,_.push({type:"unsupported-setting",setting:"frequencyPenalty",details:"frequencyPenalty is not supported for reasoning models"})),C.presence_penalty!=null&&(C.presence_penalty=void 0,_.push({type:"unsupported-setting",setting:"presencePenalty",details:"presencePenalty is not supported for reasoning models"})),C.logit_bias!=null&&(C.logit_bias=void 0,_.push({type:"other",message:"logitBias is not supported for reasoning models"})),C.logprobs!=null&&(C.logprobs=void 0,_.push({type:"other",message:"logprobs is not supported for reasoning models"})),C.top_logprobs!=null&&(C.top_logprobs=void 0,_.push({type:"other",message:"topLogprobs is not supported for reasoning models"})),C.max_tokens!=null&&(C.max_completion_tokens==null&&(C.max_completion_tokens=C.max_tokens),C.max_tokens=void 0)),f){case"regular":{const{tools:U,tool_choice:z,functions:V,function_call:B,toolWarnings:O}=Br({mode:e,useLegacyFunctionCalling:k,structuredOutputs:this.supportsStructuredOutputs});return{args:{...C,tools:U,tool_choice:z,functions:V,function_call:B},warnings:[..._,...O]}}case"object-json":return{args:{...C,response_format:this.supportsStructuredOutputs&&e.schema!=null?{type:"json_schema",json_schema:{schema:e.schema,strict:!0,name:(S=e.name)!=null?S:"response",description:e.description}}:{type:"json_object"}},warnings:_};case"object-tool":return{args:k?{...C,function_call:{name:e.tool.name},functions:[{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}]}:{...C,tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:this.supportsStructuredOutputs?!0:void 0}}]},warnings:_};default:{const U=f;throw new Error(`Unsupported type: ${U}`)}}}async doGenerate(e){var n,r,s,a,o,i,l,c;const{args:u,warnings:m}=this.getArgs(e),{responseHeaders:g,value:v,rawValue:b}=await Y({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:te(this.config.headers(),e.headers),body:u,failedResponseHandler:ue,successfulResponseHandler:ye(Wr),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:y,...d}=u,p=v.choices[0],h=(n=v.usage)==null?void 0:n.completion_tokens_details,x=(r=v.usage)==null?void 0:r.prompt_tokens_details,S={openai:{}};return h?.reasoning_tokens!=null&&(S.openai.reasoningTokens=h?.reasoning_tokens),h?.accepted_prediction_tokens!=null&&(S.openai.acceptedPredictionTokens=h?.accepted_prediction_tokens),h?.rejected_prediction_tokens!=null&&(S.openai.rejectedPredictionTokens=h?.rejected_prediction_tokens),x?.cached_tokens!=null&&(S.openai.cachedPromptTokens=x?.cached_tokens),{text:(s=p.message.content)!=null?s:void 0,toolCalls:this.settings.useLegacyFunctionCalling&&p.message.function_call?[{toolCallType:"function",toolCallId:ee(),toolName:p.message.function_call.name,args:p.message.function_call.arguments}]:(a=p.message.tool_calls)==null?void 0:a.map(f=>{var _;return{toolCallType:"function",toolCallId:(_=f.id)!=null?_:ee(),toolName:f.function.name,args:f.function.arguments}}),finishReason:Je(p.finish_reason),usage:{promptTokens:(i=(o=v.usage)==null?void 0:o.prompt_tokens)!=null?i:NaN,completionTokens:(c=(l=v.usage)==null?void 0:l.completion_tokens)!=null?c:NaN},rawCall:{rawPrompt:y,rawSettings:d},rawResponse:{headers:g,body:b},request:{body:JSON.stringify(u)},response:We(v),warnings:m,logprobs:Zt(p.logprobs),providerMetadata:S}}async doStream(e){if(this.settings.simulateStreaming){const d=await this.doGenerate(e);return{stream:new ReadableStream({start(h){if(h.enqueue({type:"response-metadata",...d.response}),d.text&&h.enqueue({type:"text-delta",textDelta:d.text}),d.toolCalls)for(const x of d.toolCalls)h.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:x.toolCallId,toolName:x.toolName,argsTextDelta:x.args}),h.enqueue({type:"tool-call",...x});h.enqueue({type:"finish",finishReason:d.finishReason,usage:d.usage,logprobs:d.logprobs,providerMetadata:d.providerMetadata}),h.close()}}),rawCall:d.rawCall,rawResponse:d.rawResponse,warnings:d.warnings}}const{args:n,warnings:r}=this.getArgs(e),s={...n,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},{responseHeaders:a,value:o}=await Y({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:te(this.config.headers(),e.headers),body:s,failedResponseHandler:ue,successfulResponseHandler:Oe(Vr),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:i,...l}=n,c=[];let u="unknown",m={promptTokens:void 0,completionTokens:void 0},g,v=!0;const{useLegacyFunctionCalling:b}=this.settings,y={openai:{}};return{stream:o.pipeThrough(new TransformStream({transform(d,p){var h,x,S,f,_,k,I,T,C,U,z,V;if(!d.success){u="error",p.enqueue({type:"error",error:d.error});return}const B=d.value;if("error"in B){u="error",p.enqueue({type:"error",error:B.error});return}if(v&&(v=!1,p.enqueue({type:"response-metadata",...We(B)})),B.usage!=null){const{prompt_tokens:A,completion_tokens:q,prompt_tokens_details:j,completion_tokens_details:M}=B.usage;m={promptTokens:A??void 0,completionTokens:q??void 0},M?.reasoning_tokens!=null&&(y.openai.reasoningTokens=M?.reasoning_tokens),M?.accepted_prediction_tokens!=null&&(y.openai.acceptedPredictionTokens=M?.accepted_prediction_tokens),M?.rejected_prediction_tokens!=null&&(y.openai.rejectedPredictionTokens=M?.rejected_prediction_tokens),j?.cached_tokens!=null&&(y.openai.cachedPromptTokens=j?.cached_tokens)}const O=B.choices[0];if(O?.finish_reason!=null&&(u=Je(O.finish_reason)),O?.delta==null)return;const L=O.delta;L.content!=null&&p.enqueue({type:"text-delta",textDelta:L.content});const J=Zt(O?.logprobs);J?.length&&(g===void 0&&(g=[]),g.push(...J));const N=b&&L.function_call!=null?[{type:"function",id:ee(),function:L.function_call,index:0}]:L.tool_calls;if(N!=null)for(const A of N){const q=A.index;if(c[q]==null){if(A.type!=="function")throw new we({data:A,message:"Expected 'function' type."});if(A.id==null)throw new we({data:A,message:"Expected 'id' to be a string."});if(((h=A.function)==null?void 0:h.name)==null)throw new we({data:A,message:"Expected 'function.name' to be a string."});c[q]={id:A.id,type:"function",function:{name:A.function.name,arguments:(x=A.function.arguments)!=null?x:""},hasFinished:!1};const M=c[q];((S=M.function)==null?void 0:S.name)!=null&&((f=M.function)==null?void 0:f.arguments)!=null&&(M.function.arguments.length>0&&p.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:M.id,toolName:M.function.name,argsTextDelta:M.function.arguments}),Be(M.function.arguments)&&(p.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(_=M.id)!=null?_:ee(),toolName:M.function.name,args:M.function.arguments}),M.hasFinished=!0));continue}const j=c[q];j.hasFinished||(((k=A.function)==null?void 0:k.arguments)!=null&&(j.function.arguments+=(T=(I=A.function)==null?void 0:I.arguments)!=null?T:""),p.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:j.id,toolName:j.function.name,argsTextDelta:(C=A.function.arguments)!=null?C:""}),((U=j.function)==null?void 0:U.name)!=null&&((z=j.function)==null?void 0:z.arguments)!=null&&Be(j.function.arguments)&&(p.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(V=j.id)!=null?V:ee(),toolName:j.function.name,args:j.function.arguments}),j.hasFinished=!0))}},flush(d){var p,h;d.enqueue({type:"finish",finishReason:u,logprobs:g,usage:{promptTokens:(p=m.promptTokens)!=null?p:NaN,completionTokens:(h=m.completionTokens)!=null?h:NaN},...y!=null?{providerMetadata:y}:{}})}})),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:a},request:{body:JSON.stringify(s)},warnings:r}}},Tn=t.object({prompt_tokens:t.number().nullish(),completion_tokens:t.number().nullish(),prompt_tokens_details:t.object({cached_tokens:t.number().nullish()}).nullish(),completion_tokens_details:t.object({reasoning_tokens:t.number().nullish(),accepted_prediction_tokens:t.number().nullish(),rejected_prediction_tokens:t.number().nullish()}).nullish()}).nullish(),Wr=t.object({id:t.string().nullish(),created:t.number().nullish(),model:t.string().nullish(),choices:t.array(t.object({message:t.object({role:t.literal("assistant").nullish(),content:t.string().nullish(),function_call:t.object({arguments:t.string(),name:t.string()}).nullish(),tool_calls:t.array(t.object({id:t.string().nullish(),type:t.literal("function"),function:t.object({name:t.string(),arguments:t.string()})})).nullish()}),index:t.number(),logprobs:t.object({content:t.array(t.object({token:t.string(),logprob:t.number(),top_logprobs:t.array(t.object({token:t.string(),logprob:t.number()}))})).nullable()}).nullish(),finish_reason:t.string().nullish()})),usage:Tn}),Vr=t.union([t.object({id:t.string().nullish(),created:t.number().nullish(),model:t.string().nullish(),choices:t.array(t.object({delta:t.object({role:t.enum(["assistant"]).nullish(),content:t.string().nullish(),function_call:t.object({name:t.string().optional(),arguments:t.string().optional()}).nullish(),tool_calls:t.array(t.object({index:t.number(),id:t.string().nullish(),type:t.literal("function").optional(),function:t.object({name:t.string().nullish(),arguments:t.string().nullish()})})).nullish()}).nullish(),logprobs:t.object({content:t.array(t.object({token:t.string(),logprob:t.number(),top_logprobs:t.array(t.object({token:t.string(),logprob:t.number()}))})).nullable()}).nullish(),finish_reason:t.string().nullable().optional(),index:t.number()})),usage:Tn}),Ct]);function ft(e){return e==="o1"||e.startsWith("o1-")||e==="o3"||e.startsWith("o3-")}function Gr(e){return e.startsWith("gpt-4o-audio-preview")}function Kr(e){var n,r;return ft(e)?(r=(n=zr[e])==null?void 0:n.systemMessageMode)!=null?r:"developer":"system"}var zr={"o1-mini":{systemMessageMode:"remove"},"o1-mini-2024-09-12":{systemMessageMode:"remove"},"o1-preview":{systemMessageMode:"remove"},"o1-preview-2024-09-12":{systemMessageMode:"remove"},"o3-mini":{systemMessageMode:"developer"},"o3-mini-2025-01-31":{systemMessageMode:"developer"}};function Xr({prompt:e,inputFormat:n,user:r="user",assistant:s="assistant"}){if(n==="prompt"&&e.length===1&&e[0].role==="user"&&e[0].content.length===1&&e[0].content[0].type==="text")return{prompt:e[0].content[0].text};let a="";e[0].role==="system"&&(a+=`${e[0].content}

`,e=e.slice(1));for(const{role:o,content:i}of e)switch(o){case"system":throw new le({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{const l=i.map(c=>{switch(c.type){case"text":return c.text;case"image":throw new E({functionality:"images"})}}).join("");a+=`${r}:
${l}

`;break}case"assistant":{const l=i.map(c=>{switch(c.type){case"text":return c.text;case"tool-call":throw new E({functionality:"tool-call messages"})}}).join("");a+=`${s}:
${l}

`;break}case"tool":throw new E({functionality:"tool messages"});default:{const l=o;throw new Error(`Unsupported role: ${l}`)}}return a+=`${s}:
`,{prompt:a,stopSequences:[`
${r}:`]}}function Qt(e){return e?.tokens.map((n,r)=>({token:n,logprob:e.token_logprobs[r],topLogprobs:e.top_logprobs?Object.entries(e.top_logprobs[r]).map(([s,a])=>({token:s,logprob:a})):[]}))}var Yr=class{constructor(e,n,r){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=n,this.config=r}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:n,prompt:r,maxTokens:s,temperature:a,topP:o,topK:i,frequencyPenalty:l,presencePenalty:c,stopSequences:u,responseFormat:m,seed:g}){var v;const b=e.type,y=[];i!=null&&y.push({type:"unsupported-setting",setting:"topK"}),m!=null&&m.type!=="text"&&y.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:d,stopSequences:p}=Xr({prompt:r,inputFormat:n}),h=[...p??[],...u??[]],x={model:this.modelId,echo:this.settings.echo,logit_bias:this.settings.logitBias,logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:s,temperature:a,top_p:o,frequency_penalty:l,presence_penalty:c,seed:g,prompt:d,stop:h.length>0?h:void 0};switch(b){case"regular":{if((v=e.tools)!=null&&v.length)throw new E({functionality:"tools"});if(e.toolChoice)throw new E({functionality:"toolChoice"});return{args:x,warnings:y}}case"object-json":throw new E({functionality:"object-json mode"});case"object-tool":throw new E({functionality:"object-tool mode"});default:{const S=b;throw new Error(`Unsupported type: ${S}`)}}}async doGenerate(e){const{args:n,warnings:r}=this.getArgs(e),{responseHeaders:s,value:a,rawValue:o}=await Y({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:te(this.config.headers(),e.headers),body:n,failedResponseHandler:ue,successfulResponseHandler:ye(Zr),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:i,...l}=n,c=a.choices[0];return{text:c.text,usage:{promptTokens:a.usage.prompt_tokens,completionTokens:a.usage.completion_tokens},finishReason:Je(c.finish_reason),logprobs:Qt(c.logprobs),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:s,body:o},response:We(a),warnings:r,request:{body:JSON.stringify(n)}}}async doStream(e){const{args:n,warnings:r}=this.getArgs(e),s={...n,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},{responseHeaders:a,value:o}=await Y({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:te(this.config.headers(),e.headers),body:s,failedResponseHandler:ue,successfulResponseHandler:Oe(Qr),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:i,...l}=n;let c="unknown",u={promptTokens:Number.NaN,completionTokens:Number.NaN},m,g=!0;return{stream:o.pipeThrough(new TransformStream({transform(v,b){if(!v.success){c="error",b.enqueue({type:"error",error:v.error});return}const y=v.value;if("error"in y){c="error",b.enqueue({type:"error",error:y.error});return}g&&(g=!1,b.enqueue({type:"response-metadata",...We(y)})),y.usage!=null&&(u={promptTokens:y.usage.prompt_tokens,completionTokens:y.usage.completion_tokens});const d=y.choices[0];d?.finish_reason!=null&&(c=Je(d.finish_reason)),d?.text!=null&&b.enqueue({type:"text-delta",textDelta:d.text});const p=Qt(d?.logprobs);p?.length&&(m===void 0&&(m=[]),m.push(...p))},flush(v){v.enqueue({type:"finish",finishReason:c,logprobs:m,usage:u})}})),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:a},warnings:r,request:{body:JSON.stringify(s)}}}},Zr=t.object({id:t.string().nullish(),created:t.number().nullish(),model:t.string().nullish(),choices:t.array(t.object({text:t.string(),finish_reason:t.string(),logprobs:t.object({tokens:t.array(t.string()),token_logprobs:t.array(t.number()),top_logprobs:t.array(t.record(t.string(),t.number())).nullable()}).nullish()})),usage:t.object({prompt_tokens:t.number(),completion_tokens:t.number()})}),Qr=t.union([t.object({id:t.string().nullish(),created:t.number().nullish(),model:t.string().nullish(),choices:t.array(t.object({text:t.string(),finish_reason:t.string().nullish(),index:t.number(),logprobs:t.object({tokens:t.array(t.string()),token_logprobs:t.array(t.number()),top_logprobs:t.array(t.record(t.string(),t.number())).nullable()}).nullish()})),usage:t.object({prompt_tokens:t.number(),completion_tokens:t.number()}).nullish()}),Ct]),eo=class{constructor(e,n,r){this.specificationVersion="v1",this.modelId=e,this.settings=n,this.config=r}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return(e=this.settings.maxEmbeddingsPerCall)!=null?e:2048}get supportsParallelCalls(){var e;return(e=this.settings.supportsParallelCalls)!=null?e:!0}async doEmbed({values:e,headers:n,abortSignal:r}){if(e.length>this.maxEmbeddingsPerCall)throw new Er({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:s,value:a}=await Y({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:te(this.config.headers(),n),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:this.settings.dimensions,user:this.settings.user},failedResponseHandler:ue,successfulResponseHandler:ye(to),abortSignal:r,fetch:this.config.fetch});return{embeddings:a.data.map(o=>o.embedding),usage:a.usage?{tokens:a.usage.prompt_tokens}:void 0,rawResponse:{headers:s}}}},to=t.object({data:t.array(t.object({embedding:t.array(t.number())})),usage:t.object({prompt_tokens:t.number()}).nullish()}),no={"dall-e-3":1,"dall-e-2":10},ro=class{constructor(e,n,r){this.modelId=e,this.settings=n,this.config=r,this.specificationVersion="v1"}get maxImagesPerCall(){var e,n;return(n=(e=this.settings.maxImagesPerCall)!=null?e:no[this.modelId])!=null?n:1}get provider(){return this.config.provider}async doGenerate({prompt:e,n,size:r,aspectRatio:s,seed:a,providerOptions:o,headers:i,abortSignal:l}){var c,u,m,g;const v=[];s!=null&&v.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),a!=null&&v.push({type:"unsupported-setting",setting:"seed"});const b=(m=(u=(c=this.config._internal)==null?void 0:c.currentDate)==null?void 0:u.call(c))!=null?m:new Date,{value:y,responseHeaders:d}=await Y({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:te(this.config.headers(),i),body:{model:this.modelId,prompt:e,n,size:r,...(g=o.openai)!=null?g:{},response_format:"b64_json"},failedResponseHandler:ue,successfulResponseHandler:ye(oo),abortSignal:l,fetch:this.config.fetch});return{images:y.data.map(p=>p.b64_json),warnings:v,response:{timestamp:b,modelId:this.modelId,headers:d}}}},oo=t.object({data:t.array(t.object({b64_json:t.string()}))});function so({prompt:e,systemMessageMode:n}){const r=[],s=[];for(const{role:a,content:o}of e)switch(a){case"system":{switch(n){case"system":{r.push({role:"system",content:o});break}case"developer":{r.push({role:"developer",content:o});break}case"remove":{s.push({type:"other",message:"system messages are removed for this model"});break}default:{const i=n;throw new Error(`Unsupported system message mode: ${i}`)}}break}case"user":{r.push({role:"user",content:o.map((i,l)=>{var c,u,m,g;switch(i.type){case"text":return{type:"input_text",text:i.text};case"image":return{type:"input_image",image_url:i.image instanceof URL?i.image.toString():`data:${(c=i.mimeType)!=null?c:"image/jpeg"};base64,${fe(i.image)}`,detail:(m=(u=i.providerMetadata)==null?void 0:u.openai)==null?void 0:m.imageDetail};case"file":{if(i.data instanceof URL)throw new E({functionality:"File URLs in user messages"});switch(i.mimeType){case"application/pdf":return{type:"input_file",filename:(g=i.filename)!=null?g:`part-${l}.pdf`,file_data:`data:application/pdf;base64,${i.data}`};default:throw new E({functionality:"Only PDF files are supported in user messages"})}}}})});break}case"assistant":{for(const i of o)switch(i.type){case"text":{r.push({role:"assistant",content:[{type:"output_text",text:i.text}]});break}case"tool-call":{r.push({type:"function_call",call_id:i.toolCallId,name:i.toolName,arguments:JSON.stringify(i.args)});break}}break}case"tool":{for(const i of o)r.push({type:"function_call_output",call_id:i.toolCallId,output:JSON.stringify(i.result)});break}default:{const i=a;throw new Error(`Unsupported role: ${i}`)}}return{messages:r,warnings:s}}function en({finishReason:e,hasToolCalls:n}){switch(e){case void 0:case null:return n?"tool-calls":"stop";case"max_output_tokens":return"length";case"content_filter":return"content-filter";default:return n?"tool-calls":"unknown"}}function ao({mode:e,strict:n}){var r;const s=(r=e.tools)!=null&&r.length?e.tools:void 0,a=[];if(s==null)return{tools:void 0,tool_choice:void 0,toolWarnings:a};const o=e.toolChoice,i=[];for(const c of s)switch(c.type){case"function":i.push({type:"function",name:c.name,description:c.description,parameters:c.parameters,strict:n?!0:void 0});break;case"provider-defined":switch(c.id){case"openai.web_search_preview":i.push({type:"web_search_preview",search_context_size:c.args.searchContextSize,user_location:c.args.userLocation});break;default:a.push({type:"unsupported-tool",tool:c});break}break;default:a.push({type:"unsupported-tool",tool:c});break}if(o==null)return{tools:i,tool_choice:void 0,toolWarnings:a};const l=o.type;switch(l){case"auto":case"none":case"required":return{tools:i,tool_choice:l,toolWarnings:a};case"tool":return{tools:i,tool_choice:{type:"function",name:o.toolName},toolWarnings:a};default:{const c=l;throw new E({functionality:`Unsupported tool choice type: ${c}`})}}}var io=class{constructor(e,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.modelId=e,this.config=n}get provider(){return this.config.provider}getArgs({mode:e,maxTokens:n,temperature:r,stopSequences:s,topP:a,topK:o,presencePenalty:i,frequencyPenalty:l,seed:c,prompt:u,providerMetadata:m,responseFormat:g}){var v,b,y;const d=[],p=ko(this.modelId),h=e.type;o!=null&&d.push({type:"unsupported-setting",setting:"topK"}),c!=null&&d.push({type:"unsupported-setting",setting:"seed"}),i!=null&&d.push({type:"unsupported-setting",setting:"presencePenalty"}),l!=null&&d.push({type:"unsupported-setting",setting:"frequencyPenalty"}),s!=null&&d.push({type:"unsupported-setting",setting:"stopSequences"});const{messages:x,warnings:S}=so({prompt:u,systemMessageMode:p.systemMessageMode});d.push(...S);const f=_n({provider:"openai",providerOptions:m,schema:So}),_=(v=f?.strictSchemas)!=null?v:!0,k={model:this.modelId,input:x,temperature:r,top_p:a,max_output_tokens:n,...g?.type==="json"&&{text:{format:g.schema!=null?{type:"json_schema",strict:_,name:(b=g.name)!=null?b:"response",description:g.description,schema:g.schema}:{type:"json_object"}}},metadata:f?.metadata,parallel_tool_calls:f?.parallelToolCalls,previous_response_id:f?.previousResponseId,store:f?.store,user:f?.user,instructions:f?.instructions,...p.isReasoningModel&&f?.reasoningEffort!=null&&{reasoning:{effort:f?.reasoningEffort}},...p.requiredAutoTruncation&&{truncation:"auto"}};switch(p.isReasoningModel&&(k.temperature!=null&&(k.temperature=void 0,d.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),k.top_p!=null&&(k.top_p=void 0,d.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"}))),h){case"regular":{const{tools:I,tool_choice:T,toolWarnings:C}=ao({mode:e,strict:_});return{args:{...k,tools:I,tool_choice:T},warnings:[...d,...C]}}case"object-json":return{args:{...k,text:{format:e.schema!=null?{type:"json_schema",strict:_,name:(y=e.name)!=null?y:"response",description:e.description,schema:e.schema}:{type:"json_object"}}},warnings:d};case"object-tool":return{args:{...k,tool_choice:{type:"function",name:e.tool.name},tools:[{type:"function",name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:_}]},warnings:d};default:{const I=h;throw new Error(`Unsupported type: ${I}`)}}}async doGenerate(e){var n,r,s,a,o;const{args:i,warnings:l}=this.getArgs(e),{responseHeaders:c,value:u,rawValue:m}=await Y({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:te(this.config.headers(),e.headers),body:i,failedResponseHandler:ue,successfulResponseHandler:ye(t.object({id:t.string(),created_at:t.number(),model:t.string(),output:t.array(t.discriminatedUnion("type",[t.object({type:t.literal("message"),role:t.literal("assistant"),content:t.array(t.object({type:t.literal("output_text"),text:t.string(),annotations:t.array(t.object({type:t.literal("url_citation"),start_index:t.number(),end_index:t.number(),url:t.string(),title:t.string()}))}))}),t.object({type:t.literal("function_call"),call_id:t.string(),name:t.string(),arguments:t.string()}),t.object({type:t.literal("web_search_call")}),t.object({type:t.literal("computer_call")}),t.object({type:t.literal("reasoning")})])),incomplete_details:t.object({reason:t.string()}).nullable(),usage:kn})),abortSignal:e.abortSignal,fetch:this.config.fetch}),g=u.output.filter(b=>b.type==="message").flatMap(b=>b.content).filter(b=>b.type==="output_text"),v=u.output.filter(b=>b.type==="function_call").map(b=>({toolCallType:"function",toolCallId:b.call_id,toolName:b.name,args:b.arguments}));return{text:g.map(b=>b.text).join(`
`),sources:g.flatMap(b=>b.annotations.map(y=>{var d,p,h;return{sourceType:"url",id:(h=(p=(d=this.config).generateId)==null?void 0:p.call(d))!=null?h:ee(),url:y.url,title:y.title}})),finishReason:en({finishReason:(n=u.incomplete_details)==null?void 0:n.reason,hasToolCalls:v.length>0}),toolCalls:v.length>0?v:void 0,usage:{promptTokens:u.usage.input_tokens,completionTokens:u.usage.output_tokens},rawCall:{rawPrompt:void 0,rawSettings:{}},rawResponse:{headers:c,body:m},request:{body:JSON.stringify(i)},response:{id:u.id,timestamp:new Date(u.created_at*1e3),modelId:u.model},providerMetadata:{openai:{responseId:u.id,cachedPromptTokens:(s=(r=u.usage.input_tokens_details)==null?void 0:r.cached_tokens)!=null?s:null,reasoningTokens:(o=(a=u.usage.output_tokens_details)==null?void 0:a.reasoning_tokens)!=null?o:null}},warnings:l}}async doStream(e){const{args:n,warnings:r}=this.getArgs(e),{responseHeaders:s,value:a}=await Y({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:te(this.config.headers(),e.headers),body:{...n,stream:!0},failedResponseHandler:ue,successfulResponseHandler:Oe(fo),abortSignal:e.abortSignal,fetch:this.config.fetch}),o=this;let i="unknown",l=NaN,c=NaN,u=null,m=null,g=null;const v={};let b=!1;return{stream:a.pipeThrough(new TransformStream({transform(y,d){var p,h,x,S,f,_,k,I;if(!y.success){i="error",d.enqueue({type:"error",error:y.error});return}const T=y.value;if(xo(T))T.item.type==="function_call"&&(v[T.output_index]={toolName:T.item.name,toolCallId:T.item.call_id},d.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:T.item.call_id,toolName:T.item.name,argsTextDelta:T.item.arguments}));else if(wo(T)){const C=v[T.output_index];C!=null&&d.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:C.toolCallId,toolName:C.toolName,argsTextDelta:T.delta})}else bo(T)?(g=T.response.id,d.enqueue({type:"response-metadata",id:T.response.id,timestamp:new Date(T.response.created_at*1e3),modelId:T.response.model})):yo(T)?d.enqueue({type:"text-delta",textDelta:T.delta}):vo(T)&&T.item.type==="function_call"?(v[T.output_index]=void 0,b=!0,d.enqueue({type:"tool-call",toolCallType:"function",toolCallId:T.item.call_id,toolName:T.item.name,args:T.item.arguments})):_o(T)?(i=en({finishReason:(p=T.response.incomplete_details)==null?void 0:p.reason,hasToolCalls:b}),l=T.response.usage.input_tokens,c=T.response.usage.output_tokens,u=(x=(h=T.response.usage.input_tokens_details)==null?void 0:h.cached_tokens)!=null?x:u,m=(f=(S=T.response.usage.output_tokens_details)==null?void 0:S.reasoning_tokens)!=null?f:m):To(T)&&d.enqueue({type:"source",source:{sourceType:"url",id:(I=(k=(_=o.config).generateId)==null?void 0:k.call(_))!=null?I:ee(),url:T.annotation.url,title:T.annotation.title}})},flush(y){y.enqueue({type:"finish",finishReason:i,usage:{promptTokens:l,completionTokens:c},...(u!=null||m!=null)&&{providerMetadata:{openai:{responseId:g,cachedPromptTokens:u,reasoningTokens:m}}}})}})),rawCall:{rawPrompt:void 0,rawSettings:{}},rawResponse:{headers:s},request:{body:JSON.stringify(n)},warnings:r}}},kn=t.object({input_tokens:t.number(),input_tokens_details:t.object({cached_tokens:t.number().nullish()}).nullish(),output_tokens:t.number(),output_tokens_details:t.object({reasoning_tokens:t.number().nullish()}).nullish()}),lo=t.object({type:t.literal("response.output_text.delta"),delta:t.string()}),uo=t.object({type:t.enum(["response.completed","response.incomplete"]),response:t.object({incomplete_details:t.object({reason:t.string()}).nullish(),usage:kn})}),co=t.object({type:t.literal("response.created"),response:t.object({id:t.string(),created_at:t.number(),model:t.string()})}),po=t.object({type:t.literal("response.output_item.done"),output_index:t.number(),item:t.discriminatedUnion("type",[t.object({type:t.literal("message")}),t.object({type:t.literal("function_call"),id:t.string(),call_id:t.string(),name:t.string(),arguments:t.string(),status:t.literal("completed")})])}),mo=t.object({type:t.literal("response.function_call_arguments.delta"),item_id:t.string(),output_index:t.number(),delta:t.string()}),ho=t.object({type:t.literal("response.output_item.added"),output_index:t.number(),item:t.discriminatedUnion("type",[t.object({type:t.literal("message")}),t.object({type:t.literal("function_call"),id:t.string(),call_id:t.string(),name:t.string(),arguments:t.string()})])}),go=t.object({type:t.literal("response.output_text.annotation.added"),annotation:t.object({type:t.literal("url_citation"),url:t.string(),title:t.string()})}),fo=t.union([lo,uo,co,po,mo,ho,go,t.object({type:t.string()}).passthrough()]);function yo(e){return e.type==="response.output_text.delta"}function vo(e){return e.type==="response.output_item.done"}function _o(e){return e.type==="response.completed"||e.type==="response.incomplete"}function bo(e){return e.type==="response.created"}function wo(e){return e.type==="response.function_call_arguments.delta"}function xo(e){return e.type==="response.output_item.added"}function To(e){return e.type==="response.output_text.annotation.added"}function ko(e){return e.startsWith("o")?e.startsWith("o1-mini")||e.startsWith("o1-preview")?{isReasoningModel:!0,systemMessageMode:"remove",requiredAutoTruncation:!1}:{isReasoningModel:!0,systemMessageMode:"developer",requiredAutoTruncation:!1}:{isReasoningModel:!1,systemMessageMode:"system",requiredAutoTruncation:!1}}var So=t.object({metadata:t.any().nullish(),parallelToolCalls:t.boolean().nullish(),previousResponseId:t.string().nullish(),store:t.boolean().nullish(),user:t.string().nullish(),reasoningEffort:t.string().nullish(),strictSchemas:t.boolean().nullish(),instructions:t.string().nullish()}),Co=t.object({});function Io({searchContextSize:e,userLocation:n}={}){return{type:"provider-defined",id:"openai.web_search_preview",args:{searchContextSize:e,userLocation:n},parameters:Co}}var Ro={webSearchPreview:Io};function Sn(e={}){var n,r,s;const a=(n=xt(e.baseURL))!=null?n:"https://api.openai.com/v1",o=(r=e.compatibility)!=null?r:"compatible",i=(s=e.name)!=null?s:"openai",l=()=>({Authorization:`Bearer ${Tt({apiKey:e.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":e.organization,"OpenAI-Project":e.project,...e.headers}),c=(d,p={})=>new Jr(d,p,{provider:`${i}.chat`,url:({path:h})=>`${a}${h}`,headers:l,compatibility:o,fetch:e.fetch}),u=(d,p={})=>new Yr(d,p,{provider:`${i}.completion`,url:({path:h})=>`${a}${h}`,headers:l,compatibility:o,fetch:e.fetch}),m=(d,p={})=>new eo(d,p,{provider:`${i}.embedding`,url:({path:h})=>`${a}${h}`,headers:l,fetch:e.fetch}),g=(d,p={})=>new ro(d,p,{provider:`${i}.image`,url:({path:h})=>`${a}${h}`,headers:l,fetch:e.fetch}),v=(d,p)=>{if(new.target)throw new Error("The OpenAI model function cannot be called with the new keyword.");return d==="gpt-3.5-turbo-instruct"?u(d,p):c(d,p)},b=d=>new io(d,{provider:`${i}.responses`,url:({path:p})=>`${a}${p}`,headers:l,fetch:e.fetch}),y=function(d,p){return v(d,p)};return y.languageModel=v,y.chat=c,y.completion=u,y.responses=b,y.embedding=m,y.textEmbedding=m,y.textEmbeddingModel=m,y.image=g,y.imageModel=g,y.tools=Ro,y}Sn({compatibility:"strict"});var jo=t.object({type:t.literal("error"),error:t.object({type:t.string(),message:t.string()})}),tn=kt({errorSchema:jo,errorToMessage:e=>e.error.message});function Mo(e){var n;const r=(n=e.tools)!=null&&n.length?e.tools:void 0,s=[],a=new Set;if(r==null)return{tools:void 0,tool_choice:void 0,toolWarnings:s,betas:a};const o=[];for(const c of r)switch(c.type){case"function":o.push({name:c.name,description:c.description,input_schema:c.parameters});break;case"provider-defined":switch(c.id){case"anthropic.computer_20250124":a.add("computer-use-2025-01-24"),o.push({name:c.name,type:"computer_20250124",display_width_px:c.args.displayWidthPx,display_height_px:c.args.displayHeightPx,display_number:c.args.displayNumber});break;case"anthropic.computer_20241022":a.add("computer-use-2024-10-22"),o.push({name:c.name,type:"computer_20241022",display_width_px:c.args.displayWidthPx,display_height_px:c.args.displayHeightPx,display_number:c.args.displayNumber});break;case"anthropic.text_editor_20250124":a.add("computer-use-2025-01-24"),o.push({name:c.name,type:"text_editor_20250124"});break;case"anthropic.text_editor_20241022":a.add("computer-use-2024-10-22"),o.push({name:c.name,type:"text_editor_20241022"});break;case"anthropic.bash_20250124":a.add("computer-use-2025-01-24"),o.push({name:c.name,type:"bash_20250124"});break;case"anthropic.bash_20241022":a.add("computer-use-2024-10-22"),o.push({name:c.name,type:"bash_20241022"});break;default:s.push({type:"unsupported-tool",tool:c});break}break;default:s.push({type:"unsupported-tool",tool:c});break}const i=e.toolChoice;if(i==null)return{tools:o,tool_choice:void 0,toolWarnings:s,betas:a};const l=i.type;switch(l){case"auto":return{tools:o,tool_choice:{type:"auto"},toolWarnings:s,betas:a};case"required":return{tools:o,tool_choice:{type:"any"},toolWarnings:s,betas:a};case"none":return{tools:void 0,tool_choice:void 0,toolWarnings:s,betas:a};case"tool":return{tools:o,tool_choice:{type:"tool",name:i.toolName},toolWarnings:s,betas:a};default:{const c=l;throw new E({functionality:`Unsupported tool choice type: ${c}`})}}}function Po({prompt:e,sendReasoning:n,warnings:r}){var s,a,o,i;const l=new Set,c=No(e);let u;const m=[];function g(v){var b;const y=v?.anthropic;return(b=y?.cacheControl)!=null?b:y?.cache_control}for(let v=0;v<c.length;v++){const b=c[v],y=v===c.length-1,d=b.type;switch(d){case"system":{if(u!=null)throw new E({functionality:"Multiple system messages that are separated by user/assistant messages"});u=b.messages.map(({content:p,providerMetadata:h})=>({type:"text",text:p,cache_control:g(h)}));break}case"user":{const p=[];for(const h of b.messages){const{role:x,content:S}=h;switch(x){case"user":{for(let f=0;f<S.length;f++){const _=S[f],k=f===S.length-1,I=(s=g(_.providerMetadata))!=null?s:k?g(h.providerMetadata):void 0;switch(_.type){case"text":{p.push({type:"text",text:_.text,cache_control:I});break}case"image":{p.push({type:"image",source:_.image instanceof URL?{type:"url",url:_.image.toString()}:{type:"base64",media_type:(a=_.mimeType)!=null?a:"image/jpeg",data:fe(_.image)},cache_control:I});break}case"file":{if(_.data instanceof URL)throw new E({functionality:"Image URLs in user messages"});if(_.mimeType!=="application/pdf")throw new E({functionality:"Non-PDF files in user messages"});l.add("pdfs-2024-09-25"),p.push({type:"document",source:{type:"base64",media_type:"application/pdf",data:_.data},cache_control:I});break}}}break}case"tool":{for(let f=0;f<S.length;f++){const _=S[f],k=f===S.length-1,I=(o=g(_.providerMetadata))!=null?o:k?g(h.providerMetadata):void 0,T=_.content!=null?_.content.map(C=>{var U;switch(C.type){case"text":return{type:"text",text:C.text,cache_control:void 0};case"image":return{type:"image",source:{type:"base64",media_type:(U=C.mimeType)!=null?U:"image/jpeg",data:C.data},cache_control:void 0}}}):JSON.stringify(_.result);p.push({type:"tool_result",tool_use_id:_.toolCallId,content:T,is_error:_.isError,cache_control:I})}break}default:{const f=x;throw new Error(`Unsupported role: ${f}`)}}}m.push({role:"user",content:p});break}case"assistant":{const p=[];for(let h=0;h<b.messages.length;h++){const x=b.messages[h],S=h===b.messages.length-1,{content:f}=x;for(let _=0;_<f.length;_++){const k=f[_],I=_===f.length-1,T=(i=g(k.providerMetadata))!=null?i:I?g(x.providerMetadata):void 0;switch(k.type){case"text":{p.push({type:"text",text:y&&S&&I?k.text.trim():k.text,cache_control:T});break}case"reasoning":{n?p.push({type:"thinking",thinking:k.text,signature:k.signature,cache_control:T}):r.push({type:"other",message:"sending reasoning content is disabled for this model"});break}case"redacted-reasoning":{p.push({type:"redacted_thinking",data:k.data,cache_control:T});break}case"tool-call":{p.push({type:"tool_use",id:k.toolCallId,name:k.toolName,input:k.args,cache_control:T});break}}}}m.push({role:"assistant",content:p});break}default:{const p=d;throw new Error(`Unsupported type: ${p}`)}}}return{prompt:{system:u,messages:m},betas:l}}function No(e){const n=[];let r;for(const s of e){const{role:a}=s;switch(a){case"system":{r?.type!=="system"&&(r={type:"system",messages:[]},n.push(r)),r.messages.push(s);break}case"assistant":{r?.type!=="assistant"&&(r={type:"assistant",messages:[]},n.push(r)),r.messages.push(s);break}case"user":{r?.type!=="user"&&(r={type:"user",messages:[]},n.push(r)),r.messages.push(s);break}case"tool":{r?.type!=="user"&&(r={type:"user",messages:[]},n.push(r)),r.messages.push(s);break}default:{const o=a;throw new Error(`Unsupported role: ${o}`)}}}return n}function nn(e){switch(e){case"end_turn":case"stop_sequence":return"stop";case"tool_use":return"tool-calls";case"max_tokens":return"length";default:return"unknown"}}var Ao=class{constructor(e,n,r){this.specificationVersion="v1",this.defaultObjectGenerationMode="tool",this.supportsImageUrls=!0,this.modelId=e,this.settings=n,this.config=r}get provider(){return this.config.provider}async getArgs({mode:e,prompt:n,maxTokens:r=4096,temperature:s,topP:a,topK:o,frequencyPenalty:i,presencePenalty:l,stopSequences:c,responseFormat:u,seed:m,providerMetadata:g}){var v,b,y;const d=e.type,p=[];i!=null&&p.push({type:"unsupported-setting",setting:"frequencyPenalty"}),l!=null&&p.push({type:"unsupported-setting",setting:"presencePenalty"}),m!=null&&p.push({type:"unsupported-setting",setting:"seed"}),u!=null&&u.type!=="text"&&p.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:h,betas:x}=Po({prompt:n,sendReasoning:(v=this.settings.sendReasoning)!=null?v:!0,warnings:p}),S=_n({provider:"anthropic",providerOptions:g,schema:qo}),f=((b=S?.thinking)==null?void 0:b.type)==="enabled",_=(y=S?.thinking)==null?void 0:y.budgetTokens,k={model:this.modelId,max_tokens:r,temperature:s,top_k:o,top_p:a,stop_sequences:c,...f&&{thinking:{type:"enabled",budget_tokens:_}},system:h.system,messages:h.messages};if(f){if(_==null)throw new E({functionality:"thinking requires a budget"});k.temperature!=null&&(k.temperature=void 0,p.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported when thinking is enabled"})),o!=null&&(k.top_k=void 0,p.push({type:"unsupported-setting",setting:"topK",details:"topK is not supported when thinking is enabled"})),a!=null&&(k.top_p=void 0,p.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported when thinking is enabled"})),k.max_tokens=r+_}switch(d){case"regular":{const{tools:I,tool_choice:T,toolWarnings:C,betas:U}=Mo(e);return{args:{...k,tools:I,tool_choice:T},warnings:[...p,...C],betas:new Set([...x,...U])}}case"object-json":throw new E({functionality:"json-mode object generation"});case"object-tool":{const{name:I,description:T,parameters:C}=e.tool;return{args:{...k,tools:[{name:I,description:T,input_schema:C}],tool_choice:{type:"tool",name:I}},warnings:p,betas:x}}default:{const I=d;throw new Error(`Unsupported type: ${I}`)}}}async getHeaders({betas:e,headers:n}){return te(await Or(this.config.headers),e.size>0?{"anthropic-beta":Array.from(e).join(",")}:{},n)}buildRequestUrl(e){var n,r,s;return(s=(r=(n=this.config).buildRequestUrl)==null?void 0:r.call(n,this.config.baseURL,e))!=null?s:`${this.config.baseURL}/messages`}transformRequestBody(e){var n,r,s;return(s=(r=(n=this.config).transformRequestBody)==null?void 0:r.call(n,e))!=null?s:e}async doGenerate(e){var n,r,s,a;const{args:o,warnings:i,betas:l}=await this.getArgs(e),{responseHeaders:c,value:u,rawValue:m}=await Y({url:this.buildRequestUrl(!1),headers:await this.getHeaders({betas:l,headers:e.headers}),body:this.transformRequestBody(o),failedResponseHandler:tn,successfulResponseHandler:ye(Eo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:g,...v}=o;let b="";for(const p of u.content)p.type==="text"&&(b+=p.text);let y;if(u.content.some(p=>p.type==="tool_use")){y=[];for(const p of u.content)p.type==="tool_use"&&y.push({toolCallType:"function",toolCallId:p.id,toolName:p.name,args:JSON.stringify(p.input)})}const d=u.content.filter(p=>p.type==="redacted_thinking"||p.type==="thinking").map(p=>p.type==="thinking"?{type:"text",text:p.thinking,signature:p.signature}:{type:"redacted",data:p.data});return{text:b,reasoning:d.length>0?d:void 0,toolCalls:y,finishReason:nn(u.stop_reason),usage:{promptTokens:u.usage.input_tokens,completionTokens:u.usage.output_tokens},rawCall:{rawPrompt:g,rawSettings:v},rawResponse:{headers:c,body:m},response:{id:(n=u.id)!=null?n:void 0,modelId:(r=u.model)!=null?r:void 0},warnings:i,providerMetadata:{anthropic:{cacheCreationInputTokens:(s=u.usage.cache_creation_input_tokens)!=null?s:null,cacheReadInputTokens:(a=u.usage.cache_read_input_tokens)!=null?a:null}},request:{body:JSON.stringify(o)}}}async doStream(e){const{args:n,warnings:r,betas:s}=await this.getArgs(e),a={...n,stream:!0},{responseHeaders:o,value:i}=await Y({url:this.buildRequestUrl(!0),headers:await this.getHeaders({betas:s,headers:e.headers}),body:this.transformRequestBody(a),failedResponseHandler:tn,successfulResponseHandler:Oe(Oo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:l,...c}=n;let u="unknown";const m={promptTokens:Number.NaN,completionTokens:Number.NaN},g={};let v,b;return{stream:i.pipeThrough(new TransformStream({transform(y,d){var p,h,x,S;if(!y.success){d.enqueue({type:"error",error:y.error});return}const f=y.value;switch(f.type){case"ping":return;case"content_block_start":{const _=f.content_block.type;switch(b=_,_){case"text":case"thinking":return;case"redacted_thinking":{d.enqueue({type:"redacted-reasoning",data:f.content_block.data});return}case"tool_use":{g[f.index]={toolCallId:f.content_block.id,toolName:f.content_block.name,jsonText:""};return}default:{const k=_;throw new Error(`Unsupported content block type: ${k}`)}}}case"content_block_stop":{if(g[f.index]!=null){const _=g[f.index];d.enqueue({type:"tool-call",toolCallType:"function",toolCallId:_.toolCallId,toolName:_.toolName,args:_.jsonText}),delete g[f.index]}b=void 0;return}case"content_block_delta":{const _=f.delta.type;switch(_){case"text_delta":{d.enqueue({type:"text-delta",textDelta:f.delta.text});return}case"thinking_delta":{d.enqueue({type:"reasoning",textDelta:f.delta.thinking});return}case"signature_delta":{b==="thinking"&&d.enqueue({type:"reasoning-signature",signature:f.delta.signature});return}case"input_json_delta":{const k=g[f.index];d.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:k.toolCallId,toolName:k.toolName,argsTextDelta:f.delta.partial_json}),k.jsonText+=f.delta.partial_json;return}default:{const k=_;throw new Error(`Unsupported delta type: ${k}`)}}}case"message_start":{m.promptTokens=f.message.usage.input_tokens,m.completionTokens=f.message.usage.output_tokens,v={anthropic:{cacheCreationInputTokens:(p=f.message.usage.cache_creation_input_tokens)!=null?p:null,cacheReadInputTokens:(h=f.message.usage.cache_read_input_tokens)!=null?h:null}},d.enqueue({type:"response-metadata",id:(x=f.message.id)!=null?x:void 0,modelId:(S=f.message.model)!=null?S:void 0});return}case"message_delta":{m.completionTokens=f.usage.output_tokens,u=nn(f.delta.stop_reason);return}case"message_stop":{d.enqueue({type:"finish",finishReason:u,usage:m,providerMetadata:v});return}case"error":{d.enqueue({type:"error",error:f.error});return}default:{const _=f;throw new Error(`Unsupported chunk type: ${_}`)}}}})),rawCall:{rawPrompt:l,rawSettings:c},rawResponse:{headers:o},warnings:r,request:{body:JSON.stringify(a)}}}},Eo=t.object({type:t.literal("message"),id:t.string().nullish(),model:t.string().nullish(),content:t.array(t.discriminatedUnion("type",[t.object({type:t.literal("text"),text:t.string()}),t.object({type:t.literal("thinking"),thinking:t.string(),signature:t.string()}),t.object({type:t.literal("redacted_thinking"),data:t.string()}),t.object({type:t.literal("tool_use"),id:t.string(),name:t.string(),input:t.unknown()})])),stop_reason:t.string().nullish(),usage:t.object({input_tokens:t.number(),output_tokens:t.number(),cache_creation_input_tokens:t.number().nullish(),cache_read_input_tokens:t.number().nullish()})}),Oo=t.discriminatedUnion("type",[t.object({type:t.literal("message_start"),message:t.object({id:t.string().nullish(),model:t.string().nullish(),usage:t.object({input_tokens:t.number(),output_tokens:t.number(),cache_creation_input_tokens:t.number().nullish(),cache_read_input_tokens:t.number().nullish()})})}),t.object({type:t.literal("content_block_start"),index:t.number(),content_block:t.discriminatedUnion("type",[t.object({type:t.literal("text"),text:t.string()}),t.object({type:t.literal("thinking"),thinking:t.string()}),t.object({type:t.literal("tool_use"),id:t.string(),name:t.string()}),t.object({type:t.literal("redacted_thinking"),data:t.string()})])}),t.object({type:t.literal("content_block_delta"),index:t.number(),delta:t.discriminatedUnion("type",[t.object({type:t.literal("input_json_delta"),partial_json:t.string()}),t.object({type:t.literal("text_delta"),text:t.string()}),t.object({type:t.literal("thinking_delta"),thinking:t.string()}),t.object({type:t.literal("signature_delta"),signature:t.string()})])}),t.object({type:t.literal("content_block_stop"),index:t.number()}),t.object({type:t.literal("error"),error:t.object({type:t.string(),message:t.string()})}),t.object({type:t.literal("message_delta"),delta:t.object({stop_reason:t.string().nullish()}),usage:t.object({output_tokens:t.number()})}),t.object({type:t.literal("message_stop")}),t.object({type:t.literal("ping")})]),qo=t.object({thinking:t.object({type:t.union([t.literal("enabled"),t.literal("disabled")]),budgetTokens:t.number().optional()}).optional()}),Do=t.object({command:t.string(),restart:t.boolean().optional()});function $o(e={}){return{type:"provider-defined",id:"anthropic.bash_20241022",args:{},parameters:Do,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}}var Uo=t.object({command:t.string(),restart:t.boolean().optional()});function Lo(e={}){return{type:"provider-defined",id:"anthropic.bash_20250124",args:{},parameters:Uo,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}}var Ho=t.object({command:t.enum(["view","create","str_replace","insert","undo_edit"]),path:t.string(),file_text:t.string().optional(),insert_line:t.number().int().optional(),new_str:t.string().optional(),old_str:t.string().optional(),view_range:t.array(t.number().int()).optional()});function Fo(e={}){return{type:"provider-defined",id:"anthropic.text_editor_20241022",args:{},parameters:Ho,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}}var Bo=t.object({command:t.enum(["view","create","str_replace","insert","undo_edit"]),path:t.string(),file_text:t.string().optional(),insert_line:t.number().int().optional(),new_str:t.string().optional(),old_str:t.string().optional(),view_range:t.array(t.number().int()).optional()});function Jo(e={}){return{type:"provider-defined",id:"anthropic.text_editor_20250124",args:{},parameters:Bo,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}}var Wo=t.object({action:t.enum(["key","type","mouse_move","left_click","left_click_drag","right_click","middle_click","double_click","screenshot","cursor_position"]),coordinate:t.array(t.number().int()).optional(),text:t.string().optional()});function Vo(e){return{type:"provider-defined",id:"anthropic.computer_20241022",args:{displayWidthPx:e.displayWidthPx,displayHeightPx:e.displayHeightPx,displayNumber:e.displayNumber},parameters:Wo,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}}var Go=t.object({action:t.enum(["key","hold_key","type","cursor_position","mouse_move","left_mouse_down","left_mouse_up","left_click","left_click_drag","right_click","middle_click","double_click","triple_click","scroll","wait","screenshot"]),coordinate:t.tuple([t.number().int(),t.number().int()]).optional(),duration:t.number().optional(),scroll_amount:t.number().optional(),scroll_direction:t.enum(["up","down","left","right"]).optional(),start_coordinate:t.tuple([t.number().int(),t.number().int()]).optional(),text:t.string().optional()});function Ko(e){return{type:"provider-defined",id:"anthropic.computer_20250124",args:{displayWidthPx:e.displayWidthPx,displayHeightPx:e.displayHeightPx,displayNumber:e.displayNumber},parameters:Go,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}}var zo={bash_20241022:$o,bash_20250124:Lo,textEditor_20241022:Fo,textEditor_20250124:Jo,computer_20241022:Vo,computer_20250124:Ko};function Cn(e={}){var n;const r=(n=xt(e.baseURL))!=null?n:"https://api.anthropic.com/v1",s=()=>({"anthropic-version":"2023-06-01","x-api-key":Tt({apiKey:e.apiKey,environmentVariableName:"ANTHROPIC_API_KEY",description:"Anthropic"}),...e.headers}),a=(i,l={})=>new Ao(i,l,{provider:"anthropic.messages",baseURL:r,headers:s,fetch:e.fetch}),o=function(i,l){if(new.target)throw new Error("The Anthropic model function cannot be called with the new keyword.");return a(i,l)};return o.languageModel=a,o.chat=a,o.messages=a,o.textEmbeddingModel=i=>{throw new bn({modelId:i,modelType:"textEmbeddingModel"})},o.tools=zo,o}Cn();function Ie(e){var n,r;return(r=(n=e?.providerMetadata)==null?void 0:n.openaiCompatible)!=null?r:{}}function Xo(e){const n=[];for(const{role:r,content:s,...a}of e){const o=Ie({...a});switch(r){case"system":{n.push({role:"system",content:s,...o});break}case"user":{if(s.length===1&&s[0].type==="text"){n.push({role:"user",content:s[0].text,...Ie(s[0])});break}n.push({role:"user",content:s.map(i=>{var l;const c=Ie(i);switch(i.type){case"text":return{type:"text",text:i.text,...c};case"image":return{type:"image_url",image_url:{url:i.image instanceof URL?i.image.toString():`data:${(l=i.mimeType)!=null?l:"image/jpeg"};base64,${fe(i.image)}`},...c};case"file":throw new E({functionality:"File content parts in user messages"})}}),...o});break}case"assistant":{let i="";const l=[];for(const c of s){const u=Ie(c);switch(c.type){case"text":{i+=c.text;break}case"tool-call":{l.push({id:c.toolCallId,type:"function",function:{name:c.toolName,arguments:JSON.stringify(c.args)},...u});break}}}n.push({role:"assistant",content:i,tool_calls:l.length>0?l:void 0,...o});break}case"tool":{for(const i of s){const l=Ie(i);n.push({role:"tool",tool_call_id:i.toolCallId,content:JSON.stringify(i.result),...l})}break}default:{const i=r;throw new Error(`Unsupported role: ${i}`)}}}return n}function rn({id:e,model:n,created:r}){return{id:e??void 0,modelId:n??void 0,timestamp:r!=null?new Date(r*1e3):void 0}}function on(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var Yo=t.object({error:t.object({message:t.string(),type:t.string().nullish(),param:t.any().nullish(),code:t.union([t.string(),t.number()]).nullish()})}),Zo={errorSchema:Yo,errorToMessage:e=>e.error.message};function Qo({mode:e,structuredOutputs:n}){var r;const s=(r=e.tools)!=null&&r.length?e.tools:void 0,a=[];if(s==null)return{tools:void 0,tool_choice:void 0,toolWarnings:a};const o=e.toolChoice,i=[];for(const c of s)c.type==="provider-defined"?a.push({type:"unsupported-tool",tool:c}):i.push({type:"function",function:{name:c.name,description:c.description,parameters:c.parameters}});if(o==null)return{tools:i,tool_choice:void 0,toolWarnings:a};const l=o.type;switch(l){case"auto":case"none":case"required":return{tools:i,tool_choice:l,toolWarnings:a};case"tool":return{tools:i,tool_choice:{type:"function",function:{name:o.toolName}},toolWarnings:a};default:{const c=l;throw new E({functionality:`Unsupported tool choice type: ${c}`})}}}var es=class{constructor(e,n,r){this.specificationVersion="v1";var s,a;this.modelId=e,this.settings=n,this.config=r;const o=(s=r.errorStructure)!=null?s:Zo;this.chunkSchema=ns(o.errorSchema),this.failedResponseHandler=kt(o),this.supportsStructuredOutputs=(a=r.supportsStructuredOutputs)!=null?a:!1}get defaultObjectGenerationMode(){return this.config.defaultObjectGenerationMode}get provider(){return this.config.provider}get providerOptionsName(){return this.config.provider.split(".")[0].trim()}getArgs({mode:e,prompt:n,maxTokens:r,temperature:s,topP:a,topK:o,frequencyPenalty:i,presencePenalty:l,providerMetadata:c,stopSequences:u,responseFormat:m,seed:g}){var v,b;const y=e.type,d=[];o!=null&&d.push({type:"unsupported-setting",setting:"topK"}),m?.type==="json"&&m.schema!=null&&!this.supportsStructuredOutputs&&d.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});const p={model:this.modelId,user:this.settings.user,max_tokens:r,temperature:s,top_p:a,frequency_penalty:i,presence_penalty:l,response_format:m?.type==="json"?this.supportsStructuredOutputs===!0&&m.schema!=null?{type:"json_schema",json_schema:{schema:m.schema,name:(v=m.name)!=null?v:"response",description:m.description}}:{type:"json_object"}:void 0,stop:u,seed:g,...c?.[this.providerOptionsName],messages:Xo(n)};switch(y){case"regular":{const{tools:h,tool_choice:x,toolWarnings:S}=Qo({mode:e,structuredOutputs:this.supportsStructuredOutputs});return{args:{...p,tools:h,tool_choice:x},warnings:[...d,...S]}}case"object-json":return{args:{...p,response_format:this.supportsStructuredOutputs===!0&&e.schema!=null?{type:"json_schema",json_schema:{schema:e.schema,name:(b=e.name)!=null?b:"response",description:e.description}}:{type:"json_object"}},warnings:d};case"object-tool":return{args:{...p,tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}}]},warnings:d};default:{const h=y;throw new Error(`Unsupported type: ${h}`)}}}async doGenerate(e){var n,r,s,a,o,i,l,c,u;const{args:m,warnings:g}=this.getArgs({...e}),v=JSON.stringify(m),{responseHeaders:b,value:y,rawValue:d}=await Y({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:te(this.config.headers(),e.headers),body:m,failedResponseHandler:this.failedResponseHandler,successfulResponseHandler:ye(ts),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:p,...h}=m,x=y.choices[0],S=(r=(n=this.config.metadataExtractor)==null?void 0:n.extractMetadata)==null?void 0:r.call(n,{parsedBody:d});return{text:(s=x.message.content)!=null?s:void 0,reasoning:(a=x.message.reasoning_content)!=null?a:void 0,toolCalls:(o=x.message.tool_calls)==null?void 0:o.map(f=>{var _;return{toolCallType:"function",toolCallId:(_=f.id)!=null?_:ee(),toolName:f.function.name,args:f.function.arguments}}),finishReason:on(x.finish_reason),usage:{promptTokens:(l=(i=y.usage)==null?void 0:i.prompt_tokens)!=null?l:NaN,completionTokens:(u=(c=y.usage)==null?void 0:c.completion_tokens)!=null?u:NaN},...S&&{providerMetadata:S},rawCall:{rawPrompt:p,rawSettings:h},rawResponse:{headers:b,body:d},response:rn(y),warnings:g,request:{body:v}}}async doStream(e){var n;if(this.settings.simulateStreaming){const y=await this.doGenerate(e);return{stream:new ReadableStream({start(p){if(p.enqueue({type:"response-metadata",...y.response}),y.reasoning)if(Array.isArray(y.reasoning))for(const h of y.reasoning)h.type==="text"&&p.enqueue({type:"reasoning",textDelta:h.text});else p.enqueue({type:"reasoning",textDelta:y.reasoning});if(y.text&&p.enqueue({type:"text-delta",textDelta:y.text}),y.toolCalls)for(const h of y.toolCalls)p.enqueue({type:"tool-call",...h});p.enqueue({type:"finish",finishReason:y.finishReason,usage:y.usage,logprobs:y.logprobs,providerMetadata:y.providerMetadata}),p.close()}}),rawCall:y.rawCall,rawResponse:y.rawResponse,warnings:y.warnings}}const{args:r,warnings:s}=this.getArgs({...e}),a=JSON.stringify({...r,stream:!0}),o=(n=this.config.metadataExtractor)==null?void 0:n.createStreamExtractor(),{responseHeaders:i,value:l}=await Y({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:te(this.config.headers(),e.headers),body:{...r,stream:!0},failedResponseHandler:this.failedResponseHandler,successfulResponseHandler:Oe(this.chunkSchema),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:c,...u}=r,m=[];let g="unknown",v={promptTokens:void 0,completionTokens:void 0},b=!0;return{stream:l.pipeThrough(new TransformStream({transform(y,d){var p,h,x,S,f,_,k,I,T,C,U,z,V,B;if(!y.success){g="error",d.enqueue({type:"error",error:y.error});return}const O=y.value;if(o?.processChunk(y.rawValue),"error"in O){g="error",d.enqueue({type:"error",error:O.error.message});return}b&&(b=!1,d.enqueue({type:"response-metadata",...rn(O)})),O.usage!=null&&(v={promptTokens:(p=O.usage.prompt_tokens)!=null?p:void 0,completionTokens:(h=O.usage.completion_tokens)!=null?h:void 0});const L=O.choices[0];if(L?.finish_reason!=null&&(g=on(L.finish_reason)),L?.delta==null)return;const J=L.delta;if(J.reasoning_content!=null&&d.enqueue({type:"reasoning",textDelta:J.reasoning_content}),J.content!=null&&d.enqueue({type:"text-delta",textDelta:J.content}),J.tool_calls!=null)for(const N of J.tool_calls){const A=N.index;if(m[A]==null){if(N.type!=="function")throw new we({data:N,message:"Expected 'function' type."});if(N.id==null)throw new we({data:N,message:"Expected 'id' to be a string."});if(((x=N.function)==null?void 0:x.name)==null)throw new we({data:N,message:"Expected 'function.name' to be a string."});m[A]={id:N.id,type:"function",function:{name:N.function.name,arguments:(S=N.function.arguments)!=null?S:""},hasFinished:!1};const j=m[A];((f=j.function)==null?void 0:f.name)!=null&&((_=j.function)==null?void 0:_.arguments)!=null&&(j.function.arguments.length>0&&d.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:j.id,toolName:j.function.name,argsTextDelta:j.function.arguments}),Be(j.function.arguments)&&(d.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(k=j.id)!=null?k:ee(),toolName:j.function.name,args:j.function.arguments}),j.hasFinished=!0));continue}const q=m[A];q.hasFinished||(((I=N.function)==null?void 0:I.arguments)!=null&&(q.function.arguments+=(C=(T=N.function)==null?void 0:T.arguments)!=null?C:""),d.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:q.id,toolName:q.function.name,argsTextDelta:(U=N.function.arguments)!=null?U:""}),((z=q.function)==null?void 0:z.name)!=null&&((V=q.function)==null?void 0:V.arguments)!=null&&Be(q.function.arguments)&&(d.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(B=q.id)!=null?B:ee(),toolName:q.function.name,args:q.function.arguments}),q.hasFinished=!0))}},flush(y){var d,p;const h=o?.buildMetadata();y.enqueue({type:"finish",finishReason:g,usage:{promptTokens:(d=v.promptTokens)!=null?d:NaN,completionTokens:(p=v.completionTokens)!=null?p:NaN},...h&&{providerMetadata:h}})}})),rawCall:{rawPrompt:c,rawSettings:u},rawResponse:{headers:i},warnings:s,request:{body:a}}}},ts=t.object({id:t.string().nullish(),created:t.number().nullish(),model:t.string().nullish(),choices:t.array(t.object({message:t.object({role:t.literal("assistant").nullish(),content:t.string().nullish(),reasoning_content:t.string().nullish(),tool_calls:t.array(t.object({id:t.string().nullish(),type:t.literal("function"),function:t.object({name:t.string(),arguments:t.string()})})).nullish()}),finish_reason:t.string().nullish()})),usage:t.object({prompt_tokens:t.number().nullish(),completion_tokens:t.number().nullish()}).nullish()}),ns=e=>t.union([t.object({id:t.string().nullish(),created:t.number().nullish(),model:t.string().nullish(),choices:t.array(t.object({delta:t.object({role:t.enum(["assistant"]).nullish(),content:t.string().nullish(),reasoning_content:t.string().nullish(),tool_calls:t.array(t.object({index:t.number(),id:t.string().nullish(),type:t.literal("function").optional(),function:t.object({name:t.string().nullish(),arguments:t.string().nullish()})})).nullish()}).nullish(),finish_reason:t.string().nullish()})),usage:t.object({prompt_tokens:t.number().nullish(),completion_tokens:t.number().nullish()}).nullish()}),e]);t.object({id:t.string().nullish(),created:t.number().nullish(),model:t.string().nullish(),choices:t.array(t.object({text:t.string(),finish_reason:t.string()})),usage:t.object({prompt_tokens:t.number(),completion_tokens:t.number()}).nullish()});t.object({data:t.array(t.object({embedding:t.array(t.number())})),usage:t.object({prompt_tokens:t.number()}).nullish()});t.object({data:t.array(t.object({b64_json:t.string()}))});var sn=e=>{var n,r;return e==null?void 0:{deepseek:{promptCacheHitTokens:(n=e.prompt_cache_hit_tokens)!=null?n:NaN,promptCacheMissTokens:(r=e.prompt_cache_miss_tokens)!=null?r:NaN}}},rs={extractMetadata:({parsedBody:e})=>{const n=Me({value:e,schema:os});return!n.success||n.value.usage==null?void 0:sn(n.value.usage)},createStreamExtractor:()=>{let e;return{processChunk:n=>{var r,s;const a=Me({value:n,schema:ss});a.success&&((s=(r=a.value.choices)==null?void 0:r[0])==null?void 0:s.finish_reason)==="stop"&&a.value.usage&&(e=a.value.usage)},buildMetadata:()=>sn(e)}}},In=t.object({prompt_cache_hit_tokens:t.number().nullish(),prompt_cache_miss_tokens:t.number().nullish()}),os=t.object({usage:In.nullish()}),ss=t.object({choices:t.array(t.object({finish_reason:t.string().nullish()})).nullish(),usage:In.nullish()});function Rn(e={}){var n;const r=xt((n=e.baseURL)!=null?n:"https://api.deepseek.com/v1"),s=()=>({Authorization:`Bearer ${Tt({apiKey:e.apiKey,environmentVariableName:"DEEPSEEK_API_KEY",description:"DeepSeek API key"})}`,...e.headers}),a=(i,l={})=>new es(i,l,{provider:"deepseek.chat",url:({path:c})=>`${r}${c}`,headers:s,fetch:e.fetch,defaultObjectGenerationMode:"json",metadataExtractor:rs}),o=(i,l)=>a(i,l);return o.languageModel=a,o.chat=a,o.textEmbeddingModel=i=>{throw new bn({modelId:i,modelType:"textEmbeddingModel"})},o}Rn();var as=typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof window=="object"?window:typeof global=="object"?global:{},ge="1.9.0",an=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/;function is(e){var n=new Set([e]),r=new Set,s=e.match(an);if(!s)return function(){return!1};var a={major:+s[1],minor:+s[2],patch:+s[3],prerelease:s[4]};if(a.prerelease!=null)return function(c){return c===e};function o(l){return r.add(l),!1}function i(l){return n.add(l),!0}return function(c){if(n.has(c))return!0;if(r.has(c))return!1;var u=c.match(an);if(!u)return o(c);var m={major:+u[1],minor:+u[2],patch:+u[3],prerelease:u[4]};return m.prerelease!=null||a.major!==m.major?o(c):a.major===0?a.minor===m.minor&&a.patch<=m.patch?i(c):o(c):a.minor<=m.minor?i(c):o(c)}}var ls=is(ge),us=ge.split(".")[0],Pe=Symbol.for("opentelemetry.js.api."+us),Ne=as;function It(e,n,r,s){var a;s===void 0&&(s=!1);var o=Ne[Pe]=(a=Ne[Pe])!==null&&a!==void 0?a:{version:ge};if(!s&&o[e]){var i=new Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return r.error(i.stack||i.message),!1}if(o.version!==ge){var i=new Error("@opentelemetry/api: Registration of version v"+o.version+" for "+e+" does not match previously registered API v"+ge);return r.error(i.stack||i.message),!1}return o[e]=n,r.debug("@opentelemetry/api: Registered a global for "+e+" v"+ge+"."),!0}function Ae(e){var n,r,s=(n=Ne[Pe])===null||n===void 0?void 0:n.version;if(!(!s||!ls(s)))return(r=Ne[Pe])===null||r===void 0?void 0:r[e]}function Rt(e,n){n.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+ge+".");var r=Ne[Pe];r&&delete r[e]}var cs=function(e,n){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var s=r.call(e),a,o=[],i;try{for(;(n===void 0||n-- >0)&&!(a=s.next()).done;)o.push(a.value)}catch(l){i={error:l}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},ps=function(e,n,r){if(r||arguments.length===2)for(var s=0,a=n.length,o;s<a;s++)(o||!(s in n))&&(o||(o=Array.prototype.slice.call(n,0,s)),o[s]=n[s]);return e.concat(o||Array.prototype.slice.call(n))},ds=function(){function e(n){this._namespace=n.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return Re("debug",this._namespace,n)},e.prototype.error=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return Re("error",this._namespace,n)},e.prototype.info=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return Re("info",this._namespace,n)},e.prototype.warn=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return Re("warn",this._namespace,n)},e.prototype.verbose=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return Re("verbose",this._namespace,n)},e}();function Re(e,n,r){var s=Ae("diag");if(s)return r.unshift(n),s[e].apply(s,ps([],cs(r),!1))}var K;(function(e){e[e.NONE=0]="NONE",e[e.ERROR=30]="ERROR",e[e.WARN=50]="WARN",e[e.INFO=60]="INFO",e[e.DEBUG=70]="DEBUG",e[e.VERBOSE=80]="VERBOSE",e[e.ALL=9999]="ALL"})(K||(K={}));function ms(e,n){e<K.NONE?e=K.NONE:e>K.ALL&&(e=K.ALL),n=n||{};function r(s,a){var o=n[s];return typeof o=="function"&&e>=a?o.bind(n):function(){}}return{error:r("error",K.ERROR),warn:r("warn",K.WARN),info:r("info",K.INFO),debug:r("debug",K.DEBUG),verbose:r("verbose",K.VERBOSE)}}var hs=function(e,n){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var s=r.call(e),a,o=[],i;try{for(;(n===void 0||n-- >0)&&!(a=s.next()).done;)o.push(a.value)}catch(l){i={error:l}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},gs=function(e,n,r){if(r||arguments.length===2)for(var s=0,a=n.length,o;s<a;s++)(o||!(s in n))&&(o||(o=Array.prototype.slice.call(n,0,s)),o[s]=n[s]);return e.concat(o||Array.prototype.slice.call(n))},fs="diag",Ve=function(){function e(){function n(a){return function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];var l=Ae("diag");if(l)return l[a].apply(l,gs([],hs(o),!1))}}var r=this,s=function(a,o){var i,l,c;if(o===void 0&&(o={logLevel:K.INFO}),a===r){var u=new Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return r.error((i=u.stack)!==null&&i!==void 0?i:u.message),!1}typeof o=="number"&&(o={logLevel:o});var m=Ae("diag"),g=ms((l=o.logLevel)!==null&&l!==void 0?l:K.INFO,a);if(m&&!o.suppressOverrideMessage){var v=(c=new Error().stack)!==null&&c!==void 0?c:"<failed to generate stacktrace>";m.warn("Current logger will be overwritten from "+v),g.warn("Current logger will overwrite one already registered from "+v)}return It("diag",g,r,!0)};r.setLogger=s,r.disable=function(){Rt(fs,r)},r.createComponentLogger=function(a){return new ds(a)},r.verbose=n("verbose"),r.debug=n("debug"),r.info=n("info"),r.warn=n("warn"),r.error=n("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}();function ys(e){return Symbol.for(e)}var vs=function(){function e(n){var r=this;r._currentContext=n?new Map(n):new Map,r.getValue=function(s){return r._currentContext.get(s)},r.setValue=function(s,a){var o=new e(r._currentContext);return o._currentContext.set(s,a),o},r.deleteValue=function(s){var a=new e(r._currentContext);return a._currentContext.delete(s),a}}return e}(),_s=new vs,bs=function(e,n){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var s=r.call(e),a,o=[],i;try{for(;(n===void 0||n-- >0)&&!(a=s.next()).done;)o.push(a.value)}catch(l){i={error:l}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},ws=function(e,n,r){if(r||arguments.length===2)for(var s=0,a=n.length,o;s<a;s++)(o||!(s in n))&&(o||(o=Array.prototype.slice.call(n,0,s)),o[s]=n[s]);return e.concat(o||Array.prototype.slice.call(n))},xs=function(){function e(){}return e.prototype.active=function(){return _s},e.prototype.with=function(n,r,s){for(var a=[],o=3;o<arguments.length;o++)a[o-3]=arguments[o];return r.call.apply(r,ws([s],bs(a),!1))},e.prototype.bind=function(n,r){return r},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),Ts=function(e,n){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var s=r.call(e),a,o=[],i;try{for(;(n===void 0||n-- >0)&&!(a=s.next()).done;)o.push(a.value)}catch(l){i={error:l}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},ks=function(e,n,r){if(r||arguments.length===2)for(var s=0,a=n.length,o;s<a;s++)(o||!(s in n))&&(o||(o=Array.prototype.slice.call(n,0,s)),o[s]=n[s]);return e.concat(o||Array.prototype.slice.call(n))},ct="context",Ss=new xs,jn=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(n){return It(ct,n,Ve.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(n,r,s){for(var a,o=[],i=3;i<arguments.length;i++)o[i-3]=arguments[i];return(a=this._getContextManager()).with.apply(a,ks([n,r,s],Ts(o),!1))},e.prototype.bind=function(n,r){return this._getContextManager().bind(n,r)},e.prototype._getContextManager=function(){return Ae(ct)||Ss},e.prototype.disable=function(){this._getContextManager().disable(),Rt(ct,Ve.instance())},e}(),yt;(function(e){e[e.NONE=0]="NONE",e[e.SAMPLED=1]="SAMPLED"})(yt||(yt={}));var Mn="0000000000000000",Pn="00000000000000000000000000000000",Cs={traceId:Pn,spanId:Mn,traceFlags:yt.NONE},je=function(){function e(n){n===void 0&&(n=Cs),this._spanContext=n}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(n,r){return this},e.prototype.setAttributes=function(n){return this},e.prototype.addEvent=function(n,r){return this},e.prototype.addLink=function(n){return this},e.prototype.addLinks=function(n){return this},e.prototype.setStatus=function(n){return this},e.prototype.updateName=function(n){return this},e.prototype.end=function(n){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(n,r){},e}(),jt=ys("OpenTelemetry Context Key SPAN");function Mt(e){return e.getValue(jt)||void 0}function Is(){return Mt(jn.getInstance().active())}function Pt(e,n){return e.setValue(jt,n)}function Rs(e){return e.deleteValue(jt)}function js(e,n){return Pt(e,new je(n))}function Nn(e){var n;return(n=Mt(e))===null||n===void 0?void 0:n.spanContext()}var Ms=/^([0-9a-f]{32})$/i,Ps=/^[0-9a-f]{16}$/i;function Ns(e){return Ms.test(e)&&e!==Pn}function As(e){return Ps.test(e)&&e!==Mn}function An(e){return Ns(e.traceId)&&As(e.spanId)}function Es(e){return new je(e)}var pt=jn.getInstance(),En=function(){function e(){}return e.prototype.startSpan=function(n,r,s){s===void 0&&(s=pt.active());var a=!!r?.root;if(a)return new je;var o=s&&Nn(s);return Os(o)&&An(o)?new je(o):new je},e.prototype.startActiveSpan=function(n,r,s,a){var o,i,l;if(!(arguments.length<2)){arguments.length===2?l=r:arguments.length===3?(o=r,l=s):(o=r,i=s,l=a);var c=i??pt.active(),u=this.startSpan(n,o,c),m=Pt(c,u);return pt.with(m,l,void 0,u)}},e}();function Os(e){return typeof e=="object"&&typeof e.spanId=="string"&&typeof e.traceId=="string"&&typeof e.traceFlags=="number"}var qs=new En,Ds=function(){function e(n,r,s,a){this._provider=n,this.name=r,this.version=s,this.options=a}return e.prototype.startSpan=function(n,r,s){return this._getTracer().startSpan(n,r,s)},e.prototype.startActiveSpan=function(n,r,s,a){var o=this._getTracer();return Reflect.apply(o.startActiveSpan,o,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var n=this._provider.getDelegateTracer(this.name,this.version,this.options);return n?(this._delegate=n,this._delegate):qs},e}(),$s=function(){function e(){}return e.prototype.getTracer=function(n,r,s){return new En},e}(),Us=new $s,ln=function(){function e(){}return e.prototype.getTracer=function(n,r,s){var a;return(a=this.getDelegateTracer(n,r,s))!==null&&a!==void 0?a:new Ds(this,n,r,s)},e.prototype.getDelegate=function(){var n;return(n=this._delegate)!==null&&n!==void 0?n:Us},e.prototype.setDelegate=function(n){this._delegate=n},e.prototype.getDelegateTracer=function(n,r,s){var a;return(a=this._delegate)===null||a===void 0?void 0:a.getTracer(n,r,s)},e}(),Ge;(function(e){e[e.UNSET=0]="UNSET",e[e.OK=1]="OK",e[e.ERROR=2]="ERROR"})(Ge||(Ge={}));var dt="trace",Ls=function(){function e(){this._proxyTracerProvider=new ln,this.wrapSpanContext=Es,this.isSpanContextValid=An,this.deleteSpan=Rs,this.getSpan=Mt,this.getActiveSpan=Is,this.getSpanContext=Nn,this.setSpan=Pt,this.setSpanContext=js}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(n){var r=It(dt,this._proxyTracerProvider,Ve.instance());return r&&this._proxyTracerProvider.setDelegate(n),r},e.prototype.getTracerProvider=function(){return Ae(dt)||this._proxyTracerProvider},e.prototype.getTracer=function(n,r){return this.getTracerProvider().getTracer(n,r)},e.prototype.disable=function(){Rt(dt,Ve.instance()),this._proxyTracerProvider=new ln},e}(),Hs=Ls.getInstance(),Fs=Object.defineProperty,Nt=(e,n)=>{for(var r in n)Fs(e,r,{get:n[r],enumerable:!0})};function Ke(e,{contentType:n,dataStreamVersion:r}){const s=new Headers(e??{});return s.has("Content-Type")||s.set("Content-Type",n),r!==void 0&&s.set("X-Vercel-AI-Data-Stream",r),s}function un(e,{contentType:n,dataStreamVersion:r}){const s={};if(e!=null)for(const[a,o]of Object.entries(e))s[a]=o;return s["Content-Type"]==null&&(s["Content-Type"]=n),r!==void 0&&(s["X-Vercel-AI-Data-Stream"]=r),s}function cn({response:e,status:n,statusText:r,headers:s,stream:a}){e.writeHead(n??200,r,s);const o=a.getReader();(async()=>{try{for(;;){const{done:l,value:c}=await o.read();if(l)break;e.write(c)}}catch(l){throw l}finally{e.end()}})()}var On="AI_InvalidArgumentError",qn=`vercel.ai.error.${On}`,Bs=Symbol.for(qn),Dn,Q=class extends P{constructor({parameter:e,value:n,message:r}){super({name:On,message:`Invalid argument for parameter ${e}: ${r}`}),this[Dn]=!0,this.parameter=e,this.value=n}static isInstance(e){return P.hasMarker(e,qn)}};Dn=Bs;var $n="AI_RetryError",Un=`vercel.ai.error.${$n}`,Js=Symbol.for(Un),Ln,pn=class extends P{constructor({message:e,reason:n,errors:r}){super({name:$n,message:e}),this[Ln]=!0,this.reason=n,this.errors=r,this.lastError=r[r.length-1]}static isInstance(e){return P.hasMarker(e,Un)}};Ln=Js;var Ws=({maxRetries:e=2,initialDelayInMs:n=2e3,backoffFactor:r=2}={})=>async s=>Hn(s,{maxRetries:e,delayInMs:n,backoffFactor:r});async function Hn(e,{maxRetries:n,delayInMs:r,backoffFactor:s},a=[]){try{return await e()}catch(o){if(qr(o)||n===0)throw o;const i=Dr(o),l=[...a,o],c=l.length;if(c>n)throw new pn({message:`Failed after ${c} attempts. Last error: ${i}`,reason:"maxRetriesExceeded",errors:l});if(o instanceof Error&&$r.isInstance(o)&&o.isRetryable===!0&&c<=n)return await Ur(r),Hn(e,{maxRetries:n,delayInMs:s*r,backoffFactor:s},l);throw c===1?o:new pn({message:`Failed after ${c} attempts with non-retryable error: '${i}'`,reason:"errorNotRetryable",errors:l})}}function Vs({maxRetries:e}){if(e!=null){if(!Number.isInteger(e))throw new Q({parameter:"maxRetries",value:e,message:"maxRetries must be an integer"});if(e<0)throw new Q({parameter:"maxRetries",value:e,message:"maxRetries must be >= 0"})}const n=e??2;return{maxRetries:n,retry:Ws({maxRetries:n})}}function vt({operationId:e,telemetry:n}){return{"operation.name":`${e}${n?.functionId!=null?` ${n.functionId}`:""}`,"resource.name":n?.functionId,"ai.operationId":e,"ai.telemetry.functionId":n?.functionId}}function Gs({model:e,settings:n,telemetry:r,headers:s}){var a;return{"ai.model.provider":e.provider,"ai.model.id":e.modelId,...Object.entries(n).reduce((o,[i,l])=>(o[`ai.settings.${i}`]=l,o),{}),...Object.entries((a=r?.metadata)!=null?a:{}).reduce((o,[i,l])=>(o[`ai.telemetry.metadata.${i}`]=l,o),{}),...Object.entries(s??{}).reduce((o,[i,l])=>(l!==void 0&&(o[`ai.request.headers.${i}`]=l),o),{})}}var Ks={startSpan(){return Fe},startActiveSpan(e,n,r,s){if(typeof n=="function")return n(Fe);if(typeof r=="function")return r(Fe);if(typeof s=="function")return s(Fe)}},Fe={spanContext(){return zs},setAttribute(){return this},setAttributes(){return this},addEvent(){return this},addLink(){return this},addLinks(){return this},setStatus(){return this},updateName(){return this},end(){return this},isRecording(){return!1},recordException(){return this}},zs={traceId:"",spanId:"",traceFlags:0};function Xs({isEnabled:e=!1,tracer:n}={}){return e?n||Hs.getTracer("ai"):Ks}function _t({name:e,tracer:n,attributes:r,fn:s,endWhenDone:a=!0}){return n.startActiveSpan(e,{attributes:r},async o=>{try{const i=await s(o);return a&&o.end(),i}catch(i){try{i instanceof Error?(o.recordException({name:i.name,message:i.message,stack:i.stack}),o.setStatus({code:Ge.ERROR,message:i.message})):o.setStatus({code:Ge.ERROR})}finally{o.end()}throw i}})}function be({telemetry:e,attributes:n}){return e?.isEnabled!==!0?{}:Object.entries(n).reduce((r,[s,a])=>{if(a===void 0)return r;if(typeof a=="object"&&"input"in a&&typeof a.input=="function"){if(e?.recordInputs===!1)return r;const o=a.input();return o===void 0?r:{...r,[s]:o}}if(typeof a=="object"&&"output"in a&&typeof a.output=="function"){if(e?.recordOutputs===!1)return r;const o=a.output();return o===void 0?r:{...r,[s]:o}}return{...r,[s]:a}},{})}var Ys=class{constructor({data:e,mimeType:n}){const r=e instanceof Uint8Array;this.base64Data=r?void 0:e,this.uint8ArrayData=r?e:void 0,this.mimeType=n}get base64(){return this.base64Data==null&&(this.base64Data=fe(this.uint8ArrayData)),this.base64Data}get uint8Array(){return this.uint8ArrayData==null&&(this.uint8ArrayData=wn(this.base64Data)),this.uint8ArrayData}},Zs=class extends Ys{constructor(e){super(e),this.type="file"}},Qs=[{mimeType:"image/gif",bytesPrefix:[71,73,70],base64Prefix:"R0lG"},{mimeType:"image/png",bytesPrefix:[137,80,78,71],base64Prefix:"iVBORw"},{mimeType:"image/jpeg",bytesPrefix:[255,216],base64Prefix:"/9j/"},{mimeType:"image/webp",bytesPrefix:[82,73,70,70],base64Prefix:"UklGRg"},{mimeType:"image/bmp",bytesPrefix:[66,77],base64Prefix:"Qk"},{mimeType:"image/tiff",bytesPrefix:[73,73,42,0],base64Prefix:"SUkqAA"},{mimeType:"image/tiff",bytesPrefix:[77,77,0,42],base64Prefix:"TU0AKg"},{mimeType:"image/avif",bytesPrefix:[0,0,0,32,102,116,121,112,97,118,105,102],base64Prefix:"AAAAIGZ0eXBhdmlm"},{mimeType:"image/heic",bytesPrefix:[0,0,0,32,102,116,121,112,104,101,105,99],base64Prefix:"AAAAIGZ0eXBoZWlj"}];function ea(e){for(const n of Qs)if(typeof e=="string"?e.startsWith(n.base64Prefix):e.length>=n.bytesPrefix.length&&n.bytesPrefix.every((r,s)=>e[s]===r))return n.mimeType}var Fn="AI_NoObjectGeneratedError",Bn=`vercel.ai.error.${Fn}`,ta=Symbol.for(Bn),Jn,dn=class extends P{constructor({message:e="No object generated.",cause:n,text:r,response:s,usage:a}){super({name:Fn,message:e,cause:n}),this[Jn]=!0,this.text=r,this.response=s,this.usage=a}static isInstance(e){return P.hasMarker(e,Bn)}};Jn=ta;var Wn="AI_DownloadError",Vn=`vercel.ai.error.${Wn}`,na=Symbol.for(Vn),Gn,mt=class extends P{constructor({url:e,statusCode:n,statusText:r,cause:s,message:a=s==null?`Failed to download ${e}: ${n} ${r}`:`Failed to download ${e}: ${s}`}){super({name:Wn,message:a,cause:s}),this[Gn]=!0,this.url=e,this.statusCode=n,this.statusText=r}static isInstance(e){return P.hasMarker(e,Vn)}};Gn=na;async function ra({url:e,fetchImplementation:n=fetch}){var r;const s=e.toString();try{const a=await n(s);if(!a.ok)throw new mt({url:s,statusCode:a.status,statusText:a.statusText});return{data:new Uint8Array(await a.arrayBuffer()),mimeType:(r=a.headers.get("content-type"))!=null?r:void 0}}catch(a){throw mt.isInstance(a)?a:new mt({url:s,cause:a})}}var Kn="AI_InvalidDataContentError",zn=`vercel.ai.error.${Kn}`,oa=Symbol.for(zn),Xn,mn=class extends P{constructor({content:e,cause:n,message:r=`Invalid data content. Expected a base64 string, Uint8Array, ArrayBuffer, or Buffer, but got ${typeof e}.`}){super({name:Kn,message:r,cause:n}),this[Xn]=!0,this.content=e}static isInstance(e){return P.hasMarker(e,zn)}};Xn=oa;var Yn=t.union([t.string(),t.instanceof(Uint8Array),t.instanceof(ArrayBuffer),t.custom(e=>{var n,r;return(r=(n=globalThis.Buffer)==null?void 0:n.isBuffer(e))!=null?r:!1},{message:"Must be a Buffer"})]);function Zn(e){return typeof e=="string"?e:e instanceof ArrayBuffer?fe(new Uint8Array(e)):fe(e)}function ze(e){if(e instanceof Uint8Array)return e;if(typeof e=="string")try{return wn(e)}catch(n){throw new mn({message:"Invalid data content. Content string is not a base64-encoded media.",content:e,cause:n})}if(e instanceof ArrayBuffer)return new Uint8Array(e);throw new mn({content:e})}function sa(e){try{return new TextDecoder().decode(e)}catch{throw new Error("Error decoding Uint8Array to text")}}var Qn="AI_InvalidMessageRoleError",er=`vercel.ai.error.${Qn}`,aa=Symbol.for(er),tr,ia=class extends P{constructor({role:e,message:n=`Invalid message role: '${e}'. Must be one of: "system", "user", "assistant", "tool".`}){super({name:Qn,message:n}),this[tr]=!0,this.role=e}static isInstance(e){return P.hasMarker(e,er)}};tr=aa;function la(e){try{const[n,r]=e.split(",");return{mimeType:n.split(";")[0].split(":")[1],base64Content:r}}catch{return{mimeType:void 0,base64Content:void 0}}}async function ua({prompt:e,modelSupportsImageUrls:n=!0,modelSupportsUrl:r=()=>!1,downloadImplementation:s=ra}){const a=await pa(e.messages,s,n,r);return[...e.system!=null?[{role:"system",content:e.system}]:[],...e.messages.map(o=>ca(o,a))]}function ca(e,n){var r,s,a,o,i,l;const c=e.role;switch(c){case"system":return{role:"system",content:e.content,providerMetadata:(r=e.providerOptions)!=null?r:e.experimental_providerMetadata};case"user":return typeof e.content=="string"?{role:"user",content:[{type:"text",text:e.content}],providerMetadata:(s=e.providerOptions)!=null?s:e.experimental_providerMetadata}:{role:"user",content:e.content.map(u=>da(u,n)).filter(u=>u.type!=="text"||u.text!==""),providerMetadata:(a=e.providerOptions)!=null?a:e.experimental_providerMetadata};case"assistant":return typeof e.content=="string"?{role:"assistant",content:[{type:"text",text:e.content}],providerMetadata:(o=e.providerOptions)!=null?o:e.experimental_providerMetadata}:{role:"assistant",content:e.content.filter(u=>u.type!=="text"||u.text!=="").map(u=>{var m;const g=(m=u.providerOptions)!=null?m:u.experimental_providerMetadata;switch(u.type){case"file":return{type:"file",data:u.data instanceof URL?u.data:Zn(u.data),filename:u.filename,mimeType:u.mimeType,providerMetadata:g};case"reasoning":return{type:"reasoning",text:u.text,signature:u.signature,providerMetadata:g};case"redacted-reasoning":return{type:"redacted-reasoning",data:u.data,providerMetadata:g};case"text":return{type:"text",text:u.text,providerMetadata:g};case"tool-call":return{type:"tool-call",toolCallId:u.toolCallId,toolName:u.toolName,args:u.args,providerMetadata:g}}}),providerMetadata:(i=e.providerOptions)!=null?i:e.experimental_providerMetadata};case"tool":return{role:"tool",content:e.content.map(u=>{var m;return{type:"tool-result",toolCallId:u.toolCallId,toolName:u.toolName,result:u.result,content:u.experimental_content,isError:u.isError,providerMetadata:(m=u.providerOptions)!=null?m:u.experimental_providerMetadata}}),providerMetadata:(l=e.providerOptions)!=null?l:e.experimental_providerMetadata};default:{const u=c;throw new ia({role:u})}}}async function pa(e,n,r,s){const a=e.filter(i=>i.role==="user").map(i=>i.content).filter(i=>Array.isArray(i)).flat().filter(i=>i.type==="image"||i.type==="file").filter(i=>!(i.type==="image"&&r===!0)).map(i=>i.type==="image"?i.image:i.data).map(i=>typeof i=="string"&&(i.startsWith("http:")||i.startsWith("https:"))?new URL(i):i).filter(i=>i instanceof URL).filter(i=>!s(i)),o=await Promise.all(a.map(async i=>({url:i,data:await n({url:i})})));return Object.fromEntries(o.map(({url:i,data:l})=>[i.toString(),l]))}function da(e,n){var r,s,a,o;if(e.type==="text")return{type:"text",text:e.text,providerMetadata:(r=e.providerOptions)!=null?r:e.experimental_providerMetadata};let i=e.mimeType,l,c,u;const m=e.type;switch(m){case"image":l=e.image;break;case"file":l=e.data;break;default:throw new Error(`Unsupported part type: ${m}`)}try{c=typeof l=="string"?new URL(l):l}catch{c=l}if(c instanceof URL)if(c.protocol==="data:"){const{mimeType:g,base64Content:v}=la(c.toString());if(g==null||v==null)throw new Error(`Invalid data URL format in part ${m}`);i=g,u=ze(v)}else{const g=n[c.toString()];g?(u=g.data,i??(i=g.mimeType)):u=c}else u=ze(c);switch(m){case"image":return u instanceof Uint8Array&&(i=(s=ea(u))!=null?s:i),{type:"image",image:u,mimeType:i,providerMetadata:(a=e.providerOptions)!=null?a:e.experimental_providerMetadata};case"file":{if(i==null)throw new Error("Mime type is missing for file part");return{type:"file",data:u instanceof Uint8Array?Zn(u):u,filename:e.filename,mimeType:i,providerMetadata:(o=e.providerOptions)!=null?o:e.experimental_providerMetadata}}}}function ma({maxTokens:e,temperature:n,topP:r,topK:s,presencePenalty:a,frequencyPenalty:o,stopSequences:i,seed:l}){if(e!=null){if(!Number.isInteger(e))throw new Q({parameter:"maxTokens",value:e,message:"maxTokens must be an integer"});if(e<1)throw new Q({parameter:"maxTokens",value:e,message:"maxTokens must be >= 1"})}if(n!=null&&typeof n!="number")throw new Q({parameter:"temperature",value:n,message:"temperature must be a number"});if(r!=null&&typeof r!="number")throw new Q({parameter:"topP",value:r,message:"topP must be a number"});if(s!=null&&typeof s!="number")throw new Q({parameter:"topK",value:s,message:"topK must be a number"});if(a!=null&&typeof a!="number")throw new Q({parameter:"presencePenalty",value:a,message:"presencePenalty must be a number"});if(o!=null&&typeof o!="number")throw new Q({parameter:"frequencyPenalty",value:o,message:"frequencyPenalty must be a number"});if(l!=null&&!Number.isInteger(l))throw new Q({parameter:"seed",value:l,message:"seed must be an integer"});return{maxTokens:e,temperature:n??0,topP:r,topK:s,presencePenalty:a,frequencyPenalty:o,stopSequences:i!=null&&i.length>0?i:void 0,seed:l}}function hn(e){var n,r,s;const a=[];for(const o of e){let i;try{i=new URL(o.url)}catch{throw new Error(`Invalid URL: ${o.url}`)}switch(i.protocol){case"http:":case"https:":{if((n=o.contentType)!=null&&n.startsWith("image/"))a.push({type:"image",image:i});else{if(!o.contentType)throw new Error("If the attachment is not an image, it must specify a content type");a.push({type:"file",data:i,mimeType:o.contentType})}break}case"data:":{let l,c,u;try{[l,c]=o.url.split(","),u=l.split(";")[0].split(":")[1]}catch{throw new Error(`Error processing data URL: ${o.url}`)}if(u==null||c==null)throw new Error(`Invalid data URL format: ${o.url}`);if((r=o.contentType)!=null&&r.startsWith("image/"))a.push({type:"image",image:ze(c)});else if((s=o.contentType)!=null&&s.startsWith("text/"))a.push({type:"text",text:sa(ze(c))});else{if(!o.contentType)throw new Error("If the attachment is not an image or text, it must specify a content type");a.push({type:"file",data:c,mimeType:o.contentType})}break}default:throw new Error(`Unsupported URL protocol: ${i.protocol}`)}}return a}var nr="AI_MessageConversionError",rr=`vercel.ai.error.${nr}`,ha=Symbol.for(rr),or,ht=class extends P{constructor({originalMessage:e,message:n}){super({name:nr,message:n}),this[or]=!0,this.originalMessage=e}static isInstance(e){return P.hasMarker(e,rr)}};or=ha;function ga(e,n){var r,s;const a=(r=n?.tools)!=null?r:{},o=[];for(let i=0;i<e.length;i++){const l=e[i],c=i===e.length-1,{role:u,content:m,experimental_attachments:g}=l;switch(u){case"system":{o.push({role:"system",content:m});break}case"user":{if(l.parts==null)o.push({role:"user",content:g?[{type:"text",text:m},...hn(g)]:m});else{const v=l.parts.filter(b=>b.type==="text").map(b=>({type:"text",text:b.text}));o.push({role:"user",content:g?[...v,...hn(g)]:v})}break}case"assistant":{if(l.parts!=null){let y=function(){const x=[];for(const f of h)switch(f.type){case"file":case"text":{x.push(f);break}case"reasoning":{for(const _ of f.details)switch(_.type){case"text":x.push({type:"reasoning",text:_.text,signature:_.signature});break;case"redacted":x.push({type:"redacted-reasoning",data:_.data});break}break}case"tool-invocation":x.push({type:"tool-call",toolCallId:f.toolInvocation.toolCallId,toolName:f.toolInvocation.toolName,args:f.toolInvocation.args});break;default:{const _=f;throw new Error(`Unsupported part: ${_}`)}}o.push({role:"assistant",content:x});const S=h.filter(f=>f.type==="tool-invocation").map(f=>f.toolInvocation);S.length>0&&o.push({role:"tool",content:S.map(f=>{if(!("result"in f))throw new ht({originalMessage:l,message:"ToolInvocation must have a result: "+JSON.stringify(f)});const{toolCallId:_,toolName:k,result:I}=f,T=a[k];return T?.experimental_toToolResultContent!=null?{type:"tool-result",toolCallId:_,toolName:k,result:T.experimental_toToolResultContent(I),experimental_content:T.experimental_toToolResultContent(I)}:{type:"tool-result",toolCallId:_,toolName:k,result:I}})}),h=[],p=!1,d++},d=0,p=!1,h=[];for(const x of l.parts)switch(x.type){case"text":{p&&y(),h.push(x);break}case"file":case"reasoning":{h.push(x);break}case"tool-invocation":{((s=x.toolInvocation.step)!=null?s:0)!==d&&y(),h.push(x),p=!0;break}}y();break}const v=l.toolInvocations;if(v==null||v.length===0){o.push({role:"assistant",content:m});break}const b=v.reduce((y,d)=>{var p;return Math.max(y,(p=d.step)!=null?p:0)},0);for(let y=0;y<=b;y++){const d=v.filter(p=>{var h;return((h=p.step)!=null?h:0)===y});d.length!==0&&(o.push({role:"assistant",content:[...c&&m&&y===0?[{type:"text",text:m}]:[],...d.map(({toolCallId:p,toolName:h,args:x})=>({type:"tool-call",toolCallId:p,toolName:h,args:x}))]}),o.push({role:"tool",content:d.map(p=>{if(!("result"in p))throw new ht({originalMessage:l,message:"ToolInvocation must have a result: "+JSON.stringify(p)});const{toolCallId:h,toolName:x,result:S}=p,f=a[x];return f?.experimental_toToolResultContent!=null?{type:"tool-result",toolCallId:h,toolName:x,result:f.experimental_toToolResultContent(S),experimental_content:f.experimental_toToolResultContent(S)}:{type:"tool-result",toolCallId:h,toolName:x,result:S}})}))}m&&!c&&o.push({role:"assistant",content:m});break}case"data":break;default:{const v=u;throw new ht({originalMessage:l,message:`Unsupported role: ${v}`})}}}return o}function fa(e){if(!Array.isArray(e))return"other";if(e.length===0)return"messages";const n=e.map(ya);return n.some(r=>r==="has-ui-specific-parts")?"ui-messages":n.every(r=>r==="has-core-specific-parts"||r==="message")?"messages":"other"}function ya(e){return typeof e=="object"&&e!==null&&(e.role==="function"||e.role==="data"||"toolInvocations"in e||"parts"in e||"experimental_attachments"in e)?"has-ui-specific-parts":typeof e=="object"&&e!==null&&"content"in e&&(Array.isArray(e.content)||"experimental_providerMetadata"in e||"providerOptions"in e)?"has-core-specific-parts":typeof e=="object"&&e!==null&&"role"in e&&"content"in e&&typeof e.content=="string"&&["system","user","assistant","tool"].includes(e.role)?"message":"other"}var bt=t.lazy(()=>t.union([t.null(),t.string(),t.number(),t.boolean(),t.record(t.string(),bt),t.array(bt)])),D=t.record(t.string(),t.record(t.string(),bt)),va=t.array(t.union([t.object({type:t.literal("text"),text:t.string()}),t.object({type:t.literal("image"),data:t.string(),mimeType:t.string().optional()})])),sr=t.object({type:t.literal("text"),text:t.string(),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),_a=t.object({type:t.literal("image"),image:t.union([Yn,t.instanceof(URL)]),mimeType:t.string().optional(),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),ar=t.object({type:t.literal("file"),data:t.union([Yn,t.instanceof(URL)]),filename:t.string().optional(),mimeType:t.string(),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),ba=t.object({type:t.literal("reasoning"),text:t.string(),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),wa=t.object({type:t.literal("redacted-reasoning"),data:t.string(),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),xa=t.object({type:t.literal("tool-call"),toolCallId:t.string(),toolName:t.string(),args:t.unknown(),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),Ta=t.object({type:t.literal("tool-result"),toolCallId:t.string(),toolName:t.string(),result:t.unknown(),content:va.optional(),isError:t.boolean().optional(),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),ka=t.object({role:t.literal("system"),content:t.string(),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),Sa=t.object({role:t.literal("user"),content:t.union([t.string(),t.array(t.union([sr,_a,ar]))]),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),Ca=t.object({role:t.literal("assistant"),content:t.union([t.string(),t.array(t.union([sr,ar,ba,wa,xa]))]),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),Ia=t.object({role:t.literal("tool"),content:t.array(Ta),providerOptions:D.optional(),experimental_providerMetadata:D.optional()}),Ra=t.union([ka,Sa,Ca,Ia]);function ja({prompt:e,tools:n}){if(e.prompt==null&&e.messages==null)throw new le({prompt:e,message:"prompt or messages must be defined"});if(e.prompt!=null&&e.messages!=null)throw new le({prompt:e,message:"prompt and messages cannot be defined at the same time"});if(e.system!=null&&typeof e.system!="string")throw new le({prompt:e,message:"system must be a string"});if(e.prompt!=null){if(typeof e.prompt!="string")throw new le({prompt:e,message:"prompt must be a string"});return{type:"prompt",system:e.system,messages:[{role:"user",content:e.prompt}]}}if(e.messages!=null){const r=fa(e.messages);if(r==="other")throw new le({prompt:e,message:"messages must be an array of CoreMessage or UIMessage"});const s=r==="ui-messages"?ga(e.messages,{tools:n}):e.messages;if(s.length===0)throw new le({prompt:e,message:"messages must not be empty"});const a=Me({value:s,schema:t.array(Ra)});if(!a.success)throw new le({prompt:e,message:"messages must be an array of CoreMessage or UIMessage",cause:a.error});return{type:"messages",messages:s,system:e.system}}throw new Error("unreachable")}function Ma({promptTokens:e,completionTokens:n}){return{promptTokens:e,completionTokens:n,totalTokens:e+n}}function Pa(e,n){return{promptTokens:e.promptTokens+n.promptTokens,completionTokens:e.completionTokens+n.completionTokens,totalTokens:e.totalTokens+n.totalTokens}}var Na="JSON schema:",Aa="You MUST answer with a JSON object that matches the JSON schema above.",Ea="You MUST answer with JSON.";function Oa({prompt:e,schema:n,schemaPrefix:r=n!=null?Na:void 0,schemaSuffix:s=n!=null?Aa:Ea}){return[e!=null&&e.length>0?e:void 0,e!=null&&e.length>0?"":void 0,r,n!=null?JSON.stringify(n):void 0,s].filter(a=>a!=null).join(`
`)}function gt(e){const n=e.pipeThrough(new TransformStream);return n[Symbol.asyncIterator]=()=>{const r=n.getReader();return{async next(){const{done:s,value:a}=await r.read();return s?{done:!0,value:void 0}:{done:!1,value:a}}}},n}xe({prefix:"aiobj",size:24});var W=class{constructor(){this.status={type:"pending"},this._resolve=void 0,this._reject=void 0}get value(){return this.promise?this.promise:(this.promise=new Promise((e,n)=>{this.status.type==="resolved"?e(this.status.value):this.status.type==="rejected"&&n(this.status.error),this._resolve=e,this._reject=n}),this.promise)}resolve(e){var n;this.status={type:"resolved",value:e},this.promise&&((n=this._resolve)==null||n.call(this,e))}reject(e){var n;this.status={type:"rejected",error:e},this.promise&&((n=this._reject)==null||n.call(this,e))}};function gn(){let e,n;return{promise:new Promise((s,a)=>{e=s,n=a}),resolve:e,reject:n}}function qa(){let e=[],n=null,r=!1,s=gn();const a=async()=>{if(r&&e.length===0){n?.close();return}if(e.length===0)return s=gn(),await s.promise,a();try{const{value:o,done:i}=await e[0].read();i?(e.shift(),e.length>0?await a():r&&n?.close()):n?.enqueue(o)}catch(o){n?.error(o),e.shift(),r&&e.length===0&&n?.close()}};return{stream:new ReadableStream({start(o){n=o},pull:a,async cancel(){for(const o of e)await o.cancel();e=[],r=!0}}),addStream:o=>{if(r)throw new Error("Cannot add inner stream: outer stream is closed");e.push(o.getReader()),s.resolve()},close:()=>{r=!0,s.resolve(),e.length===0&&n?.close()},terminate:()=>{r=!0,s.resolve(),e.forEach(o=>o.cancel()),e=[],n?.close()}}}function Da(){var e,n;return(n=(e=globalThis?.performance)==null?void 0:e.now())!=null?n:Date.now()}xe({prefix:"aiobj",size:24});var ir="AI_NoOutputSpecifiedError",lr=`vercel.ai.error.${ir}`,$a=Symbol.for(lr),ur,Ua=class extends P{constructor({message:e="No output specified."}={}){super({name:ir,message:e}),this[ur]=!0}static isInstance(e){return P.hasMarker(e,lr)}};ur=$a;var cr="AI_ToolExecutionError",pr=`vercel.ai.error.${cr}`,La=Symbol.for(pr),dr,Ha=class extends P{constructor({toolArgs:e,toolName:n,toolCallId:r,cause:s,message:a=`Error executing tool ${n}: ${St(s)}`}){super({name:cr,message:a,cause:s}),this[dr]=!0,this.toolArgs=e,this.toolName=n,this.toolCallId=r}static isInstance(e){return P.hasMarker(e,pr)}};dr=La;function Fa(e){return e!=null&&Object.keys(e).length>0}function Ba({tools:e,toolChoice:n,activeTools:r}){return Fa(e)?{tools:(r!=null?Object.entries(e).filter(([a])=>r.includes(a)):Object.entries(e)).map(([a,o])=>{const i=o.type;switch(i){case void 0:case"function":return{type:"function",name:a,description:o.description,parameters:Xe(o.parameters).jsonSchema};case"provider-defined":return{type:"provider-defined",name:a,id:o.id,args:o.args};default:{const l=i;throw new Error(`Unsupported tool type: ${l}`)}}}),toolChoice:n==null?{type:"auto"}:typeof n=="string"?{type:n}:{type:"tool",toolName:n.toolName}}:{tools:void 0,toolChoice:void 0}}var Ja=/^([\s\S]*?)(\s+)(\S*)$/;function Wa(e){const n=e.match(Ja);return n?{prefix:n[1],whitespace:n[2],suffix:n[3]}:void 0}var mr="AI_InvalidToolArgumentsError",hr=`vercel.ai.error.${mr}`,Va=Symbol.for(hr),gr,fr=class extends P{constructor({toolArgs:e,toolName:n,cause:r,message:s=`Invalid arguments for tool ${n}: ${St(r)}`}){super({name:mr,message:s,cause:r}),this[gr]=!0,this.toolArgs=e,this.toolName=n}static isInstance(e){return P.hasMarker(e,hr)}};gr=Va;var yr="AI_NoSuchToolError",vr=`vercel.ai.error.${yr}`,Ga=Symbol.for(vr),_r,wt=class extends P{constructor({toolName:e,availableTools:n=void 0,message:r=`Model tried to call unavailable tool '${e}'. ${n===void 0?"No tools are available.":`Available tools: ${n.join(", ")}.`}`}){super({name:yr,message:r}),this[_r]=!0,this.toolName=e,this.availableTools=n}static isInstance(e){return P.hasMarker(e,vr)}};_r=Ga;var br="AI_ToolCallRepairError",wr=`vercel.ai.error.${br}`,Ka=Symbol.for(wr),xr,za=class extends P{constructor({cause:e,originalError:n,message:r=`Error repairing tool call: ${St(e)}`}){super({name:br,message:r,cause:e}),this[xr]=!0,this.originalError=n}static isInstance(e){return P.hasMarker(e,wr)}};xr=Ka;async function Xa({toolCall:e,tools:n,repairToolCall:r,system:s,messages:a}){if(n==null)throw new wt({toolName:e.toolName});try{return await fn({toolCall:e,tools:n})}catch(o){if(r==null||!(wt.isInstance(o)||fr.isInstance(o)))throw o;let i=null;try{i=await r({toolCall:e,tools:n,parameterSchema:({toolName:l})=>Xe(n[l].parameters).jsonSchema,system:s,messages:a,error:o})}catch(l){throw new za({cause:l,originalError:o})}if(i==null)throw o;return await fn({toolCall:i,tools:n})}}async function fn({toolCall:e,tools:n}){const r=e.toolName,s=n[r];if(s==null)throw new wt({toolName:e.toolName,availableTools:Object.keys(n)});const a=Xe(s.parameters),o=e.args.trim()===""?Me({value:{},schema:a}):xn({text:e.args,schema:a});if(o.success===!1)throw new fr({toolName:r,toolArgs:e.args,cause:o.error});return{type:"tool-call",toolCallId:e.toolCallId,toolName:r,args:o.value}}function Ya(e){const n=e.filter(r=>r.type==="text").map(r=>r.text).join("");return n.length>0?n:void 0}function yn({text:e="",files:n,reasoning:r,tools:s,toolCalls:a,toolResults:o,messageId:i,generateMessageId:l}){const c=[];return c.push({role:"assistant",content:[...r.map(u=>u.type==="text"?{...u,type:"reasoning"}:{...u,type:"redacted-reasoning"}),...n.map(u=>({type:"file",data:u.base64,mimeType:u.mimeType})),{type:"text",text:e},...a],id:i}),o.length>0&&c.push({role:"tool",id:l(),content:o.map(u=>{const m=s[u.toolName];return m?.experimental_toToolResultContent!=null?{type:"tool-result",toolCallId:u.toolCallId,toolName:u.toolName,result:m.experimental_toToolResultContent(u.result),experimental_content:m.experimental_toToolResultContent(u.result)}:{type:"tool-result",toolCallId:u.toolCallId,toolName:u.toolName,result:u.result}})}),c}xe({prefix:"aitxt",size:24});xe({prefix:"msg",size:24});var Za={};Nt(Za,{object:()=>ni,text:()=>ti});var Tr="AI_InvalidStreamPartError",kr=`vercel.ai.error.${Tr}`,Qa=Symbol.for(kr),Sr,ei=class extends P{constructor({chunk:e,message:n}){super({name:Tr,message:n}),this[Sr]=!0,this.chunk=e}static isInstance(e){return P.hasMarker(e,kr)}};Sr=Qa;var ti=()=>({type:"text",responseFormat:()=>({type:"text"}),injectIntoSystemPrompt({system:e}){return e},parsePartial({text:e}){return{partial:e}},parseOutput({text:e}){return e}}),ni=({schema:e})=>{const n=Xe(e);return{type:"object",responseFormat:({model:r})=>({type:"json",schema:r.supportsStructuredOutputs?n.jsonSchema:void 0}),injectIntoSystemPrompt({system:r,model:s}){return s.supportsStructuredOutputs?r:Oa({prompt:r,schema:n.jsonSchema})},parsePartial({text:r}){const s=Lr(r);switch(s.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:s.value};default:{const a=s.state;throw new Error(`Unsupported parse state: ${a}`)}}},parseOutput({text:r},s){const a=xn({text:r});if(!a.success)throw new dn({message:"No object generated: could not parse the response.",cause:a.error,text:r,response:s.response,usage:s.usage});const o=Me({value:a.value,schema:n});if(!o.success)throw new dn({message:"No object generated: response did not match schema.",cause:o.error,text:r,response:s.response,usage:s.usage});return o.value}}};function ri(e){return e===void 0?[]:Array.isArray(e)?e:[e]}function At(e,n){const r=e.getReader(),s=n.getReader();let a,o,i=!1,l=!1;async function c(m){try{a==null&&(a=r.read());const g=await a;a=void 0,g.done?m.close():m.enqueue(g.value)}catch(g){m.error(g)}}async function u(m){try{o==null&&(o=s.read());const g=await o;o=void 0,g.done?m.close():m.enqueue(g.value)}catch(g){m.error(g)}}return new ReadableStream({async pull(m){try{if(i){await u(m);return}if(l){await c(m);return}a==null&&(a=r.read()),o==null&&(o=s.read());const{result:g,reader:v}=await Promise.race([a.then(b=>({result:b,reader:r})),o.then(b=>({result:b,reader:s}))]);g.done||m.enqueue(g.value),v===r?(a=void 0,g.done&&(await u(m),i=!0)):(o=void 0,g.done&&(l=!0,await c(m)))}catch(g){m.error(g)}},cancel(){r.cancel(),s.cancel()}})}function oi({tools:e,generatorStream:n,toolCallStreaming:r,tracer:s,telemetry:a,system:o,messages:i,abortSignal:l,repairToolCall:c}){let u=null;const m=new ReadableStream({start(h){u=h}}),g={},v=new Set;let b=!1,y;function d(){b&&v.size===0&&(y!=null&&u.enqueue(y),u.close())}const p=new TransformStream({async transform(h,x){const S=h.type;switch(S){case"text-delta":case"reasoning":case"reasoning-signature":case"redacted-reasoning":case"source":case"response-metadata":case"error":{x.enqueue(h);break}case"file":{x.enqueue(new Zs({data:h.data,mimeType:h.mimeType}));break}case"tool-call-delta":{r&&(g[h.toolCallId]||(x.enqueue({type:"tool-call-streaming-start",toolCallId:h.toolCallId,toolName:h.toolName}),g[h.toolCallId]=!0),x.enqueue({type:"tool-call-delta",toolCallId:h.toolCallId,toolName:h.toolName,argsTextDelta:h.argsTextDelta}));break}case"tool-call":{try{const f=await Xa({toolCall:h,tools:e,repairToolCall:c,system:o,messages:i});x.enqueue(f);const _=e[f.toolName];if(_.execute!=null){const k=ee();v.add(k),_t({name:"ai.toolCall",attributes:be({telemetry:a,attributes:{...vt({operationId:"ai.toolCall",telemetry:a}),"ai.toolCall.name":f.toolName,"ai.toolCall.id":f.toolCallId,"ai.toolCall.args":{output:()=>JSON.stringify(f.args)}}}),tracer:s,fn:async I=>_.execute(f.args,{toolCallId:f.toolCallId,messages:i,abortSignal:l}).then(T=>{u.enqueue({...f,type:"tool-result",result:T}),v.delete(k),d();try{I.setAttributes(be({telemetry:a,attributes:{"ai.toolCall.result":{output:()=>JSON.stringify(T)}}}))}catch{}},T=>{u.enqueue({type:"error",error:new Ha({toolCallId:f.toolCallId,toolName:f.toolName,toolArgs:f.args,cause:T})}),v.delete(k),d()})})}}catch(f){u.enqueue({type:"error",error:f})}break}case"finish":{y={type:"finish",finishReason:h.finishReason,logprobs:h.logprobs,usage:Ma(h.usage),experimental_providerMetadata:h.providerMetadata};break}default:{const f=S;throw new Error(`Unhandled chunk type: ${f}`)}}},flush(){b=!0,d()}});return new ReadableStream({async start(h){return Promise.all([n.pipeThrough(p).pipeTo(new WritableStream({write(x){h.enqueue(x)},close(){}})),m.pipeTo(new WritableStream({write(x){h.enqueue(x)},close(){h.close()}}))])}})}var si=xe({prefix:"aitxt",size:24}),ai=xe({prefix:"msg",size:24});function ii({model:e,tools:n,toolChoice:r,system:s,prompt:a,messages:o,maxRetries:i,abortSignal:l,headers:c,maxSteps:u=1,experimental_generateMessageId:m=ai,experimental_output:g,experimental_continueSteps:v=!1,experimental_telemetry:b,experimental_providerMetadata:y,providerOptions:d=y,experimental_toolCallStreaming:p=!1,toolCallStreaming:h=p,experimental_activeTools:x,experimental_repairToolCall:S,experimental_transform:f,onChunk:_,onError:k,onFinish:I,onStepFinish:T,_internal:{now:C=Da,generateId:U=si,currentDate:z=()=>new Date}={},...V}){return new ui({model:e,telemetry:b,headers:c,settings:V,maxRetries:i,abortSignal:l,system:s,prompt:a,messages:o,tools:n,toolChoice:r,toolCallStreaming:h,transforms:ri(f),activeTools:x,repairToolCall:S,maxSteps:u,output:g,continueSteps:v,providerOptions:d,onChunk:_,onError:k,onFinish:I,onStepFinish:T,now:C,currentDate:z,generateId:U,generateMessageId:m})}function li(e){if(!e)return new TransformStream({transform(o,i){i.enqueue({part:o,partialOutput:void 0})}});let n="",r="",s="";function a({controller:o,partialOutput:i=void 0}){o.enqueue({part:{type:"text-delta",textDelta:r},partialOutput:i}),r=""}return new TransformStream({transform(o,i){if(o.type==="step-finish"&&a({controller:i}),o.type!=="text-delta"){i.enqueue({part:o,partialOutput:void 0});return}n+=o.textDelta,r+=o.textDelta;const l=e.parsePartial({text:n});if(l!=null){const c=JSON.stringify(l.partial);c!==s&&(a({controller:i,partialOutput:l.partial}),s=c)}},flush(o){r.length>0&&a({controller:o})}})}var ui=class{constructor({model:e,telemetry:n,headers:r,settings:s,maxRetries:a,abortSignal:o,system:i,prompt:l,messages:c,tools:u,toolChoice:m,toolCallStreaming:g,transforms:v,activeTools:b,repairToolCall:y,maxSteps:d,output:p,continueSteps:h,providerOptions:x,now:S,currentDate:f,generateId:_,generateMessageId:k,onChunk:I,onError:T,onFinish:C,onStepFinish:U}){this.warningsPromise=new W,this.usagePromise=new W,this.finishReasonPromise=new W,this.providerMetadataPromise=new W,this.textPromise=new W,this.reasoningPromise=new W,this.reasoningDetailsPromise=new W,this.sourcesPromise=new W,this.filesPromise=new W,this.toolCallsPromise=new W,this.toolResultsPromise=new W,this.requestPromise=new W,this.responsePromise=new W,this.stepsPromise=new W;var z;if(d<1)throw new Q({parameter:"maxSteps",value:d,message:"maxSteps must be at least 1"});this.output=p;let V="",B="",O="",L=[],J=[],N,A=[];const q=[],j={id:_(),timestamp:f(),modelId:e.modelId,messages:[]};let M=[],Te=[],Ze,Qe,Dt="initial";const ce=[];let et;const Rr=new TransformStream({async transform(ne,re){re.enqueue(ne);const{part:w}=ne;if((w.type==="text-delta"||w.type==="reasoning"||w.type==="source"||w.type==="tool-call"||w.type==="tool-result"||w.type==="tool-call-streaming-start"||w.type==="tool-call-delta")&&await I?.({chunk:w}),w.type==="error"&&await T?.({error:w.error}),w.type==="text-delta"&&(V+=w.textDelta,B+=w.textDelta,O+=w.textDelta),w.type==="reasoning"&&(N==null?(N={type:"text",text:w.textDelta},L.push(N)):N.text+=w.textDelta),w.type==="reasoning-signature"){if(N==null)throw new P({name:"InvalidStreamPart",message:"reasoning-signature without reasoning"});N.signature=w.signature,N=void 0}if(w.type==="redacted-reasoning"&&L.push({type:"redacted",data:w.data}),w.type==="file"&&J.push(w),w.type==="source"&&(q.push(w.source),A.push(w.source)),w.type==="tool-call"&&M.push(w),w.type==="tool-result"&&Te.push(w),w.type==="step-finish"){const G=yn({text:B,files:J,reasoning:L,tools:u??{},toolCalls:M,toolResults:Te,messageId:w.messageId,generateMessageId:k}),ae=ce.length;let X="done";ae+1<d&&(h&&w.finishReason==="length"&&M.length===0?X="continue":M.length>0&&Te.length===M.length&&(X="tool-result"));const De={stepType:Dt,text:V,reasoning:Ya(L),reasoningDetails:L,files:J,sources:A,toolCalls:M,toolResults:Te,finishReason:w.finishReason,usage:w.usage,warnings:w.warnings,logprobs:w.logprobs,request:w.request,response:{...w.response,messages:[...j.messages,...G]},providerMetadata:w.experimental_providerMetadata,experimental_providerMetadata:w.experimental_providerMetadata,isContinued:w.isContinued};await U?.(De),ce.push(De),M=[],Te=[],V="",A=[],L=[],J=[],N=void 0,X!=="done"&&(Dt=X),X!=="continue"&&(j.messages.push(...G),B="")}w.type==="finish"&&(j.id=w.response.id,j.timestamp=w.response.timestamp,j.modelId=w.response.modelId,j.headers=w.response.headers,Qe=w.usage,Ze=w.finishReason)},async flush(ne){var re;try{if(ce.length===0)return;const w=ce[ce.length-1];H.warningsPromise.resolve(w.warnings),H.requestPromise.resolve(w.request),H.responsePromise.resolve(w.response),H.toolCallsPromise.resolve(w.toolCalls),H.toolResultsPromise.resolve(w.toolResults),H.providerMetadataPromise.resolve(w.experimental_providerMetadata),H.reasoningPromise.resolve(w.reasoning),H.reasoningDetailsPromise.resolve(w.reasoningDetails);const G=Ze??"unknown",ae=Qe??{completionTokens:NaN,promptTokens:NaN,totalTokens:NaN};H.finishReasonPromise.resolve(G),H.usagePromise.resolve(ae),H.textPromise.resolve(O),H.sourcesPromise.resolve(q),H.filesPromise.resolve(w.files),H.stepsPromise.resolve(ce),await C?.({finishReason:G,logprobs:void 0,usage:ae,text:O,reasoning:w.reasoning,reasoningDetails:w.reasoningDetails,files:w.files,sources:w.sources,toolCalls:w.toolCalls,toolResults:w.toolResults,request:(re=w.request)!=null?re:{},response:w.response,warnings:w.warnings,providerMetadata:w.providerMetadata,experimental_providerMetadata:w.experimental_providerMetadata,steps:ce}),et.setAttributes(be({telemetry:n,attributes:{"ai.response.finishReason":G,"ai.response.text":{output:()=>O},"ai.response.toolCalls":{output:()=>{var X;return(X=w.toolCalls)!=null&&X.length?JSON.stringify(w.toolCalls):void 0}},"ai.usage.promptTokens":ae.promptTokens,"ai.usage.completionTokens":ae.completionTokens}}))}catch(w){ne.error(w)}finally{et.end()}}}),qe=qa();this.addStream=qe.addStream,this.closeStream=qe.close;let tt=qe.stream;for(const ne of v)tt=tt.pipeThrough(ne({tools:u,stopStream(){qe.terminate()}}));this.baseStream=tt.pipeThrough(li(p)).pipeThrough(Rr);const{maxRetries:jr,retry:Mr}=Vs({maxRetries:a}),nt=Xs(n),$t=Gs({model:e,telemetry:n,headers:r,settings:{...s,maxRetries:jr}}),rt=ja({prompt:{system:(z=p?.injectIntoSystemPrompt({system:i,model:e}))!=null?z:i,prompt:l,messages:c},tools:u}),H=this;_t({name:"ai.streamText",attributes:be({telemetry:n,attributes:{...vt({operationId:"ai.streamText",telemetry:n}),...$t,"ai.prompt":{input:()=>JSON.stringify({system:i,prompt:l,messages:c})},"ai.settings.maxSteps":d}}),tracer:nt,endWhenDone:!1,fn:async ne=>{et=ne;async function re({currentStep:w,responseMessages:G,usage:ae,stepType:X,previousStepText:De,hasLeadingWhitespace:Pr,messageId:$e}){var Ut;const ot=G.length===0?rt.type:"messages",Lt=[...rt.messages,...G],Ht=await ua({prompt:{type:ot,system:rt.system,messages:Lt},modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:(Ut=e.supportsUrl)==null?void 0:Ut.bind(e)}),Ue={type:"regular",...Ba({tools:u,toolChoice:m,activeTools:b})},{result:{stream:Nr,warnings:st,rawResponse:Le,request:Ft},doStreamSpan:ve,startTimestampMs:Bt}=await Mr(()=>_t({name:"ai.streamText.doStream",attributes:be({telemetry:n,attributes:{...vt({operationId:"ai.streamText.doStream",telemetry:n}),...$t,"ai.prompt.format":{input:()=>ot},"ai.prompt.messages":{input:()=>JSON.stringify(Ht)},"ai.prompt.tools":{input:()=>{var R;return(R=Ue.tools)==null?void 0:R.map($=>JSON.stringify($))}},"ai.prompt.toolChoice":{input:()=>Ue.toolChoice!=null?JSON.stringify(Ue.toolChoice):void 0},"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":s.frequencyPenalty,"gen_ai.request.max_tokens":s.maxTokens,"gen_ai.request.presence_penalty":s.presencePenalty,"gen_ai.request.stop_sequences":s.stopSequences,"gen_ai.request.temperature":s.temperature,"gen_ai.request.top_k":s.topK,"gen_ai.request.top_p":s.topP}}),tracer:nt,endWhenDone:!1,fn:async R=>({startTimestampMs:S(),doStreamSpan:R,result:await e.doStream({mode:Ue,...ma(s),inputFormat:ot,responseFormat:p?.responseFormat({model:e}),prompt:Ht,providerMetadata:x,abortSignal:o,headers:r})})})),Ar=oi({tools:u,generatorStream:Nr,toolCallStreaming:g,tracer:nt,telemetry:n,system:i,messages:Lt,repairToolCall:y,abortSignal:o}),Jt=Ft??{},pe=[],at=[],it=[],Wt=[];let de,me="unknown",ie={promptTokens:0,completionTokens:0,totalTokens:0},ke,Vt=!0,Se="",Gt=X==="continue"?De:"",lt,Z={id:_(),timestamp:f(),modelId:e.modelId},_e="",Kt=!1,zt=!0,Xt=!1;async function ut({controller:R,chunk:$}){R.enqueue($),Se+=$.textDelta,Gt+=$.textDelta,Kt=!0,Xt=$.textDelta.trimEnd()!==$.textDelta}H.addStream(Ar.pipeThrough(new TransformStream({async transform(R,$){var oe,Ce,he;if(Vt){const se=S()-Bt;Vt=!1,ve.addEvent("ai.stream.firstChunk",{"ai.response.msToFirstChunk":se}),ve.setAttributes({"ai.response.msToFirstChunk":se}),$.enqueue({type:"step-start",messageId:$e,request:Jt,warnings:st??[]})}if(R.type==="text-delta"&&R.textDelta.length===0)return;const Yt=R.type;switch(Yt){case"text-delta":{if(h){const se=zt&&Pr?R.textDelta.trimStart():R.textDelta;if(se.length===0)break;zt=!1,_e+=se;const He=Wa(_e);He!=null&&(_e=He.suffix,await ut({controller:$,chunk:{type:"text-delta",textDelta:He.prefix+He.whitespace}}))}else await ut({controller:$,chunk:R});break}case"reasoning":{$.enqueue(R),de==null?(de={type:"text",text:R.textDelta},it.push(de)):de.text+=R.textDelta;break}case"reasoning-signature":{if($.enqueue(R),de==null)throw new ei({chunk:R,message:"reasoning-signature without reasoning"});de.signature=R.signature,de=void 0;break}case"redacted-reasoning":{$.enqueue(R),it.push({type:"redacted",data:R.data});break}case"tool-call":{$.enqueue(R),pe.push(R);break}case"tool-result":{$.enqueue(R),at.push(R);break}case"response-metadata":{Z={id:(oe=R.id)!=null?oe:Z.id,timestamp:(Ce=R.timestamp)!=null?Ce:Z.timestamp,modelId:(he=R.modelId)!=null?he:Z.modelId};break}case"finish":{ie=R.usage,me=R.finishReason,ke=R.experimental_providerMetadata,lt=R.logprobs;const se=S()-Bt;ve.addEvent("ai.stream.finish"),ve.setAttributes({"ai.response.msToFinish":se,"ai.response.avgCompletionTokensPerSecond":1e3*ie.completionTokens/se});break}case"file":{Wt.push(R),$.enqueue(R);break}case"source":case"tool-call-streaming-start":case"tool-call-delta":{$.enqueue(R);break}case"error":{$.enqueue(R),me="error";break}default:{const se=Yt;throw new Error(`Unknown chunk type: ${se}`)}}},async flush(R){const $=pe.length>0?JSON.stringify(pe):void 0;let oe="done";w+1<d&&(h&&me==="length"&&pe.length===0?oe="continue":pe.length>0&&at.length===pe.length&&(oe="tool-result")),h&&_e.length>0&&(oe!=="continue"||X==="continue"&&!Kt)&&(await ut({controller:R,chunk:{type:"text-delta",textDelta:_e}}),_e="");try{ve.setAttributes(be({telemetry:n,attributes:{"ai.response.finishReason":me,"ai.response.text":{output:()=>Se},"ai.response.toolCalls":{output:()=>$},"ai.response.id":Z.id,"ai.response.model":Z.modelId,"ai.response.timestamp":Z.timestamp.toISOString(),"ai.usage.promptTokens":ie.promptTokens,"ai.usage.completionTokens":ie.completionTokens,"gen_ai.response.finish_reasons":[me],"gen_ai.response.id":Z.id,"gen_ai.response.model":Z.modelId,"gen_ai.usage.input_tokens":ie.promptTokens,"gen_ai.usage.output_tokens":ie.completionTokens}}))}catch{}finally{ve.end()}R.enqueue({type:"step-finish",finishReason:me,usage:ie,providerMetadata:ke,experimental_providerMetadata:ke,logprobs:lt,request:Jt,response:{...Z,headers:Le?.headers},warnings:st,isContinued:oe==="continue",messageId:$e});const Ce=Pa(ae,ie);if(oe==="done")R.enqueue({type:"finish",finishReason:me,usage:Ce,providerMetadata:ke,experimental_providerMetadata:ke,logprobs:lt,response:{...Z,headers:Le?.headers}}),H.closeStream();else{if(X==="continue"){const he=G[G.length-1];typeof he.content=="string"?he.content+=Se:he.content.push({text:Se,type:"text"})}else G.push(...yn({text:Se,files:Wt,reasoning:it,tools:u??{},toolCalls:pe,toolResults:at,messageId:$e,generateMessageId:k}));await re({currentStep:w+1,responseMessages:G,usage:Ce,stepType:oe,previousStepText:Gt,hasLeadingWhitespace:Xt,messageId:oe==="continue"?$e:k()})}}})))}await re({currentStep:0,responseMessages:[],usage:{promptTokens:0,completionTokens:0,totalTokens:0},previousStepText:"",stepType:"initial",hasLeadingWhitespace:!1,messageId:k()})}}).catch(ne=>{H.addStream(new ReadableStream({start(re){re.enqueue({type:"error",error:ne}),re.close()}})),H.closeStream()})}get warnings(){return this.warningsPromise.value}get usage(){return this.usagePromise.value}get finishReason(){return this.finishReasonPromise.value}get experimental_providerMetadata(){return this.providerMetadataPromise.value}get providerMetadata(){return this.providerMetadataPromise.value}get text(){return this.textPromise.value}get reasoning(){return this.reasoningPromise.value}get reasoningDetails(){return this.reasoningDetailsPromise.value}get sources(){return this.sourcesPromise.value}get files(){return this.filesPromise.value}get toolCalls(){return this.toolCallsPromise.value}get toolResults(){return this.toolResultsPromise.value}get request(){return this.requestPromise.value}get response(){return this.responsePromise.value}get steps(){return this.stepsPromise.value}teeStream(){const[e,n]=this.baseStream.tee();return this.baseStream=n,e}get textStream(){return gt(this.teeStream().pipeThrough(new TransformStream({transform({part:e},n){e.type==="text-delta"&&n.enqueue(e.textDelta)}})))}get fullStream(){return gt(this.teeStream().pipeThrough(new TransformStream({transform({part:e},n){n.enqueue(e)}})))}async consumeStream(){const e=this.fullStream;for await(const n of e);}get experimental_partialOutputStream(){if(this.output==null)throw new Ua;return gt(this.teeStream().pipeThrough(new TransformStream({transform({partialOutput:e},n){e!=null&&n.enqueue(e)}})))}toDataStreamInternal({getErrorMessage:e=()=>"An error occurred.",sendUsage:n=!0,sendReasoning:r=!1,sendSources:s=!1,experimental_sendFinish:a=!0}){return this.fullStream.pipeThrough(new TransformStream({transform:async(o,i)=>{const l=o.type;switch(l){case"text-delta":{i.enqueue(F("text",o.textDelta));break}case"reasoning":{r&&i.enqueue(F("reasoning",o.textDelta));break}case"redacted-reasoning":{r&&i.enqueue(F("redacted_reasoning",{data:o.data}));break}case"reasoning-signature":{r&&i.enqueue(F("reasoning_signature",{signature:o.signature}));break}case"file":{i.enqueue(F("file",{mimeType:o.mimeType,data:o.base64}));break}case"source":{s&&i.enqueue(F("source",o.source));break}case"tool-call-streaming-start":{i.enqueue(F("tool_call_streaming_start",{toolCallId:o.toolCallId,toolName:o.toolName}));break}case"tool-call-delta":{i.enqueue(F("tool_call_delta",{toolCallId:o.toolCallId,argsTextDelta:o.argsTextDelta}));break}case"tool-call":{i.enqueue(F("tool_call",{toolCallId:o.toolCallId,toolName:o.toolName,args:o.args}));break}case"tool-result":{i.enqueue(F("tool_result",{toolCallId:o.toolCallId,result:o.result}));break}case"error":{i.enqueue(F("error",e(o.error)));break}case"step-start":{i.enqueue(F("start_step",{messageId:o.messageId}));break}case"step-finish":{i.enqueue(F("finish_step",{finishReason:o.finishReason,usage:n?{promptTokens:o.usage.promptTokens,completionTokens:o.usage.completionTokens}:void 0,isContinued:o.isContinued}));break}case"finish":{a&&i.enqueue(F("finish_message",{finishReason:o.finishReason,usage:n?{promptTokens:o.usage.promptTokens,completionTokens:o.usage.completionTokens}:void 0}));break}default:{const c=l;throw new Error(`Unknown chunk type: ${c}`)}}}}))}pipeDataStreamToResponse(e,{status:n,statusText:r,headers:s,data:a,getErrorMessage:o,sendUsage:i,sendReasoning:l,sendSources:c,experimental_sendFinish:u}={}){cn({response:e,status:n,statusText:r,headers:un(s,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"}),stream:this.toDataStream({data:a,getErrorMessage:o,sendUsage:i,sendReasoning:l,sendSources:c,experimental_sendFinish:u})})}pipeTextStreamToResponse(e,n){cn({response:e,status:n?.status,statusText:n?.statusText,headers:un(n?.headers,{contentType:"text/plain; charset=utf-8"}),stream:this.textStream.pipeThrough(new TextEncoderStream)})}toDataStream(e){const n=this.toDataStreamInternal({getErrorMessage:e?.getErrorMessage,sendUsage:e?.sendUsage,sendReasoning:e?.sendReasoning,sendSources:e?.sendSources,experimental_sendFinish:e?.experimental_sendFinish}).pipeThrough(new TextEncoderStream);return e?.data?At(e?.data.stream,n):n}mergeIntoDataStream(e,n){e.merge(this.toDataStreamInternal({getErrorMessage:e.onError,sendUsage:n?.sendUsage,sendReasoning:n?.sendReasoning,sendSources:n?.sendSources,experimental_sendFinish:n?.experimental_sendFinish}))}toDataStreamResponse({headers:e,status:n,statusText:r,data:s,getErrorMessage:a,sendUsage:o,sendReasoning:i,sendSources:l,experimental_sendFinish:c}={}){return new Response(this.toDataStream({data:s,getErrorMessage:a,sendUsage:o,sendReasoning:i,sendSources:l,experimental_sendFinish:c}),{status:n,statusText:r,headers:Ke(e,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}toTextStreamResponse(e){var n;return new Response(this.textStream.pipeThrough(new TextEncoderStream),{status:(n=e?.status)!=null?n:200,headers:Ke(e?.headers,{contentType:"text/plain; charset=utf-8"})})}},ci=t.object({name:t.string(),version:t.string()}).passthrough(),Et=t.object({_meta:t.optional(t.object({}).passthrough())}).passthrough(),Ee=Et,pi=t.object({method:t.string(),params:t.optional(Et)}),di=t.object({experimental:t.optional(t.object({}).passthrough()),logging:t.optional(t.object({}).passthrough()),prompts:t.optional(t.object({listChanged:t.optional(t.boolean())}).passthrough()),resources:t.optional(t.object({subscribe:t.optional(t.boolean()),listChanged:t.optional(t.boolean())}).passthrough()),tools:t.optional(t.object({listChanged:t.optional(t.boolean())}).passthrough())}).passthrough();Ee.extend({protocolVersion:t.string(),capabilities:di,serverInfo:ci,instructions:t.optional(t.string())});var mi=Ee.extend({nextCursor:t.optional(t.string())}),hi=t.object({name:t.string(),description:t.optional(t.string()),inputSchema:t.object({type:t.literal("object"),properties:t.optional(t.object({}).passthrough())}).passthrough()}).passthrough();mi.extend({tools:t.array(hi)});var gi=t.object({type:t.literal("text"),text:t.string()}).passthrough(),fi=t.object({type:t.literal("image"),data:t.string().base64(),mimeType:t.string()}).passthrough(),Cr=t.object({uri:t.string(),mimeType:t.optional(t.string())}).passthrough(),yi=Cr.extend({text:t.string()}),vi=Cr.extend({blob:t.string().base64()}),_i=t.object({type:t.literal("resource"),resource:t.union([yi,vi])}).passthrough();Ee.extend({content:t.array(t.union([gi,fi,_i])),isError:t.boolean().default(!1).optional()}).or(Ee.extend({toolResult:t.unknown()}));var Ye="2.0",bi=t.object({jsonrpc:t.literal(Ye),id:t.union([t.string(),t.number().int()])}).merge(pi).strict(),wi=t.object({jsonrpc:t.literal(Ye),id:t.union([t.string(),t.number().int()]),result:Ee}).strict(),xi=t.object({jsonrpc:t.literal(Ye),id:t.union([t.string(),t.number().int()]),error:t.object({code:t.number().int(),message:t.string(),data:t.optional(t.unknown())})}).strict(),Ti=t.object({jsonrpc:t.literal(Ye)}).merge(t.object({method:t.string(),params:t.optional(Et)})).strict();t.union([bi,Ti,wi,xi]);var ki={};Nt(ki,{mergeIntoDataStream:()=>Ii,toDataStream:()=>Si,toDataStreamResponse:()=>Ci});function Ir(e={}){const n=new TextEncoder;let r="";return new TransformStream({async start(){e.onStart&&await e.onStart()},async transform(s,a){a.enqueue(n.encode(s)),r+=s,e.onToken&&await e.onToken(s),e.onText&&typeof s=="string"&&await e.onText(s)},async flush(){e.onCompletion&&await e.onCompletion(r),e.onFinal&&await e.onFinal(r)}})}function Ot(e,n){return e.pipeThrough(new TransformStream({transform:async(r,s)=>{var a;if(typeof r=="string"){s.enqueue(r);return}if("event"in r){r.event==="on_chat_model_stream"&&vn((a=r.data)==null?void 0:a.chunk,s);return}vn(r,s)}})).pipeThrough(Ir(n)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(r,s)=>{s.enqueue(F("text",r))}}))}function Si(e,n){return Ot(e,n).pipeThrough(new TextEncoderStream)}function Ci(e,n){var r;const s=Ot(e,n?.callbacks).pipeThrough(new TextEncoderStream),a=n?.data,o=n?.init,i=a?At(a.stream,s):s;return new Response(i,{status:(r=o?.status)!=null?r:200,statusText:o?.statusText,headers:Ke(o?.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function Ii(e,n){n.dataStream.merge(Ot(e,n.callbacks))}function vn(e,n){if(typeof e.content=="string")n.enqueue(e.content);else{const r=e.content;for(const s of r)s.type==="text"&&n.enqueue(s.text)}}var Ri={};Nt(Ri,{mergeIntoDataStream:()=>Pi,toDataStream:()=>ji,toDataStreamResponse:()=>Mi});function qt(e,n){const r=Ni();return Hr(e[Symbol.asyncIterator]()).pipeThrough(new TransformStream({async transform(s,a){a.enqueue(r(s.delta))}})).pipeThrough(Ir(n)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(s,a)=>{a.enqueue(F("text",s))}}))}function ji(e,n){return qt(e,n).pipeThrough(new TextEncoderStream)}function Mi(e,n={}){var r;const{init:s,data:a,callbacks:o}=n,i=qt(e,o).pipeThrough(new TextEncoderStream),l=a?At(a.stream,i):i;return new Response(l,{status:(r=s?.status)!=null?r:200,statusText:s?.statusText,headers:Ke(s?.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function Pi(e,n){n.dataStream.merge(qt(e,n.callbacks))}function Ni(){let e=!0;return n=>(e&&(n=n.trimStart(),n&&(e=!1)),n)}async function Ei(e){const{messages:n,configSettings:r}=e;console.debug("Chat API: ",{messageCount:n.length,modelType:r?.modelType});const s=r?.modelType||"gpt-4o",a=r?.systemPrompt||"GeoGebraGeoGebra";let o="";if(s.startsWith("claude")?o=r?.apiKeys?.anthropic||"":s.startsWith("deepseek")?o=r?.apiKeys?.deepseek||"":o=r?.apiKeys?.openai||"",!o){const u=s.startsWith("claude")?" Anthropic API ":s.startsWith("deepseek")?" DeepSeek API ":" OpenAI API ";throw new Error(`${u} API `)}let i;s.startsWith("claude")?i=Cn({apiKey:o}):s.startsWith("deepseek")?i=Rn({apiKey:o}):i=Sn({apiKey:o});const l=i(s);return await ii({model:l,system:a,messages:n})}export{Ei as callChatAPI};
